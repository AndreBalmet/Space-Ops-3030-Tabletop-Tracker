<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tabletop Character Tracker Pro</title>
    <style>
        /* Starfield Animation */
        .starfield {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000000;
            overflow: hidden;
            z-index: -1;
        }

        .star {
            position: absolute;
            background: white;
            border-radius: 50%;
            animation: twinkle 3s infinite;
        }

        @keyframes twinkle {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }

        /* Landing Page */
        .landing-page {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
            position: relative;
            z-index: 1;
        }

        .landing-logo {
            max-width: 600px;
            width: 90%;
            margin-bottom: 60px;
            filter: drop-shadow(0 0 20px rgba(255, 149, 0, 0.5));
        }

        .landing-menu {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            max-width: 600px;
            width: 100%;
        }

        .menu-button {
            background: rgba(255, 149, 0, 0.1);
            border: 2px solid #FF9500;
            color: #FF9500;
            font-size: 1.3em;
            font-weight: bold;
            padding: 40px 20px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .menu-button:hover {
            background: #FF9500;
            color: #000000;
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(255, 149, 0, 0.4);
        }

        .menu-button .icon {
            font-size: 2em;
            display: block;
            margin-bottom: 10px;
        }

        @media (max-width: 768px) {
            .landing-menu {
                grid-template-columns: 1fr;
            }
            
            .menu-button {
                padding: 30px 20px;
                font-size: 1.1em;
            }
        }

        @keyframes damageFlash {
            0% {
                box-shadow: 0 0 0 0 rgba(255, 68, 68, 0);
                background: rgba(255, 68, 68, 0);
            }
            10% {
                box-shadow: 0 0 30px 10px rgba(255, 68, 68, 0.8);
                background: rgba(255, 68, 68, 0.3);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(255, 68, 68, 0);
                background: rgba(255, 68, 68, 0);
            }
        }

        .damage-flash {
            animation: damageFlash 2s ease-out;
        }

        @keyframes healFlash {
            0% {
                box-shadow: 0 0 0 0 rgba(156, 175, 136, 0);
                background: rgba(156, 175, 136, 0);
            }
            10% {
                box-shadow: 0 0 30px 10px rgba(156, 175, 136, 0.8);
                background: rgba(156, 175, 136, 0.3);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(156, 175, 136, 0);
                background: rgba(156, 175, 136, 0);
            }
        }

        .heal-flash {
            animation: healFlash 2s ease-out;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #0a0a0a;
            color: #ffffff;
            padding: 0;
            margin: 0;
            min-height: 100vh;
        }

        .logo-header {
            background: #000000;
            padding: 20px;
            text-align: center;
            border-bottom: 3px solid #FF9500;
            margin-bottom: 0;
        }

        .logo-header img {
            max-width: 500px;
            width: 100%;
            height: auto;
        }

        .main-content {
            padding: 20px;
        }

        .header {
            background: rgba(0, 0, 0, 0.8);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid #FF9500;
        }

        .header h1 {
            color: #FF9500;
            margin-bottom: 15px;
            font-size: 2em;
        }

        .mission-section {
            background: rgba(255, 149, 0, 0.1);
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            margin-bottom: 20px;
            border: 1px solid #FF9500;
        }

        .mission-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .mission-name {
            font-size: 1.2em;
            color: #FF9500;
            font-weight: bold;
        }

        .mission-name.editable {
            cursor: pointer;
            border-bottom: 2px dashed #FF9500;
        }

        .mission-name.editable:hover {
            color: #9CAF88;
        }

        .objectives-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 10px;
        }

        .objective-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 5px;
            border-left: 3px solid #9CAF88;
        }

        .objective-item.completed {
            opacity: 0.6;
            border-left-color: #FF9500;
        }

        .objective-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .objective-text {
            flex: 1;
            color: #ffffff;
        }

        .objective-item.completed .objective-text {
            text-decoration: line-through;
            color: #9CAF88;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .tab {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid #333;
            border-radius: 5px;
            color: #ffffff;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .tab.active {
            background: #FF9500;
            color: #000000;
            border-color: #FF9500;
        }

        .tab:hover {
            background: rgba(255, 215, 0, 0.3);
            border-color: #FF9500;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .session-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        .session-controls input {
            padding: 10px;
            border: 1px solid #FF9500;
            background: #1a1a1a;
            color: #ffffff;
            border-radius: 5px;
            font-size: 14px;
            flex: 1;
            min-width: 200px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            font-weight: 600;
        }

        .btn-primary {
            background: #FF9500;
            color: #000000;
        }

        .btn-primary:hover {
            background: #FFC700;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #333333;
            color: #ffffff;
        }

        .btn-secondary:hover {
            background: #444444;
        }

        .btn-success {
            background: #9CAF88;
            color: #000000;
        }

        .btn-success:hover {
            background: #AAC096;
        }

        .btn-danger {
            background: #ff4444;
            color: white;
        }

        .btn-warning {
            background: #FF9500;
            color: #000000;
        }

        .btn-info {
            background: #9CAF88;
            color: #000000;
        }

        .btn-purple {
            background: #9CAF88;
            color: #000000;
        }

        .session-info {
            margin-top: 15px;
            padding: 10px;
            background: rgba(255, 215, 0, 0.1);
            border-radius: 5px;
            border-left: 3px solid #FF9500;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .undo-section, .combat-log-section {
            margin-top: 10px;
            padding: 10px;
            background: rgba(156, 175, 136, 0.1);
            border-radius: 5px;
            border-left: 3px solid #9CAF88;
        }

        .action-history, .combat-log {
            max-height: 200px;
            overflow-y: auto;
            margin-top: 10px;
        }

        .action-item, .log-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            background: rgba(255, 255, 255, 0.05);
            margin-bottom: 5px;
            border-radius: 5px;
            font-size: 0.9em;
            border: 1px solid #333;
        }

        .action-item .action-text, .log-item .log-text {
            flex: 1;
        }

        .action-item .action-time, .log-item .log-time {
            color: #9CAF88;
            font-size: 0.85em;
            margin-right: 10px;
        }

        .sessions-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .session-card {
            background: rgba(0, 0, 0, 0.6);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #FF9500;
            transition: all 0.3s;
        }

        .session-card:hover {
            border-color: #9CAF88;
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(255, 215, 0, 0.3);
        }

        .session-card.archived {
            opacity: 0.6;
            border-color: #666;
        }

        .session-card h3 {
            color: #FF9500;
            margin-bottom: 10px;
        }

        .session-meta {
            font-size: 0.9em;
            color: #9CAF88;
            margin-bottom: 10px;
        }

        .session-actions {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .session-actions button {
            flex: 1;
            min-width: 80px;
            padding: 8px;
            font-size: 0.85em;
        }

        /* Initiative Tracker */
        .initiative-tracker {
            background: rgba(237, 137, 54, 0.1);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 3px solid #ed8936;
        }

        .initiative-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 10px;
        }

        .initiative-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 5px;
            border-left: 3px solid #ed8936;
        }

        .initiative-item.active-turn {
            border-left-color: #48bb78;
            background: rgba(72, 187, 120, 0.1);
        }

        .initiative-number {
            font-size: 1.2em;
            font-weight: bold;
            color: #ed8936;
            min-width: 40px;
        }

        .initiative-char {
            flex: 1;
            font-weight: 600;
        }

        /* Dice Roller */
        .dice-roller {
            background: rgba(159, 122, 234, 0.1);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 3px solid #9f7aea;
        }

        .dice-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .dice-btn {
            padding: 10px 15px;
            background: #9f7aea;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }

        .dice-btn:hover {
            background: #b794f4;
            transform: scale(1.05);
        }

        .dice-result {
            margin-top: 15px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 5px;
            text-align: center;
        }

        .dice-result-value {
            font-size: 2em;
            font-weight: bold;
            color: #9f7aea;
        }

        .dice-history {
            max-height: 150px;
            overflow-y: auto;
            margin-top: 10px;
        }

        .dice-history-item {
            padding: 5px;
            font-size: 0.9em;
            color: #a0a0a0;
        }

        .teams-container {
            display: flex;
            flex-direction: column;
            gap: 30px;
        }

        .team {
            background: rgba(0, 0, 0, 0.6);
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #FF9500;
        }

        .team-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #FF9500;
        }

        .team-header h2 {
            color: #FF9500;
            font-size: 1.5em;
        }

        .team-header .team-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .view-toggle {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .characters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }

        .characters-grid.compact {
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
        }
        
        .characters-grid.tiny {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .model-card {
            background: #1a1a1a;
            border-radius: 8px;
            padding: 15px;
            border: 2px solid #FF9500;
            transition: all 0.3s;
        }

        .model-card.compact {
            padding: 10px;
        }

        /* Ultra-Compact View */
        .model-card.tiny {
            width: 100px;
            padding: 8px;
            text-align: center;
        }

        .model-card.tiny .model-portrait-new {
            width: 40px;
            height: 40px;
            margin: 0 auto 5px auto;
        }

        .model-card.tiny .model-name-new {
            font-size: 0.75em;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 3px;
        }

        .model-card.tiny .ultra-hp {
            font-size: 0.7em;
            color: #9CAF88;
        }

        .model-card.tiny .ultra-turn {
            font-size: 1.2em;
            margin-top: 3px;
        }

        .team-container.tiny {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
        }

        .model-card.dead {
            opacity: 0.5;
            border-color: #ff4444;
        }

        .model-card:hover {
            border-color: #9CAF88;
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(156, 175, 136, 0.3);
        }

        .model-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .model-header.compact {
            gap: 10px;
            margin-bottom: 10px;
        }

        .model-portrait {
            width: 80px;
            height: 80px;
            border-radius: 8px;
            object-fit: cover;
            border: 2px solid #FF9500;
            background: #0a0a0a;
            cursor: pointer;
            transition: all 0.3s;
        }

        .model-portrait:hover {
            border-color: #9CAF88;
            transform: scale(1.05);
        }

        .model-portrait.compact {
            width: 50px;
            height: 50px;
        }

        .model-info h3 {
            color: #FF9500;
            margin-bottom: 5px;
            font-size: 1.2em;
        }

        .model-info.compact h3 {
            font-size: 1em;
        }

        .model-role {
            color: #9CAF88;
            font-size: 0.9em;
        }

        .model-role.compact {
            font-size: 0.8em;
        }

        .expand-toggle {
            cursor: pointer;
            color: #9CAF88;
            font-size: 0.9em;
            margin-top: 5px;
        }

        .expand-toggle:hover {
            color: #FF9500;
        }

        .model-details {
            display: block;
        }

        .model-details.hidden {
            display: none;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }

        .stats-grid.compact {
            grid-template-columns: repeat(auto-fit, minmax(70px, 1fr));
            gap: 5px;
            margin-bottom: 10px;
        }

        .stat {
            background: rgba(255, 255, 255, 0.05);
            padding: 8px;
            border-radius: 5px;
            border: 1px solid #333;
        }

        .stat.compact {
            padding: 5px;
        }

        .stat-label {
            font-size: 0.75em;
            color: #9CAF88;
            margin-bottom: 3px;
        }

        .stat-label.compact {
            font-size: 0.65em;
        }

        .stat-value {
            font-size: 1.1em;
            color: #FF9500;
            font-weight: bold;
        }

        .stat-value.compact {
            font-size: 0.9em;
        }

        .health-section {
            background: rgba(255, 215, 0, 0.05);
            padding: 12px;
            border-radius: 5px;
            margin-bottom: 15px;
            border: 1px solid #FF9500;
        }

        .health-section.compact {
            padding: 8px;
            margin-bottom: 10px;
        }

        .health-label {
            font-size: 0.9em;
            color: #FF9500;
            margin-bottom: 8px;
        }

        .health-label.compact {
            font-size: 0.8em;
            margin-bottom: 5px;
        }

        .health-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .health-controls.compact {
            gap: 5px;
        }

        .health-btn {
            width: 35px;
            height: 35px;
            border: none;
            border-radius: 5px;
            font-size: 18px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s;
        }

        .health-btn.compact {
            width: 25px;
            height: 25px;
            font-size: 14px;
        }

        .health-btn:hover {
            transform: scale(1.1);
        }

        .health-value {
            flex: 1;
            text-align: center;
            font-size: 1.5em;
            font-weight: bold;
            color: #9CAF88;
            padding: 5px;
            background: rgba(156, 175, 136, 0.1);
            border-radius: 5px;
            border: 1px solid #9CAF88;
        }

        .health-value.compact {
            font-size: 1.1em;
            padding: 3px;
        }

        /* Status Effects */
        .status-effects {
            margin-bottom: 15px;
        }

        .status-effects h4 {
            font-size: 0.9em;
            color: #a0a0a0;
            margin-bottom: 8px;
        }

        .status-effect-item {
            display: inline-block;
            background: rgba(237, 137, 54, 0.2);
            padding: 5px 10px;
            border-radius: 15px;
            margin-right: 5px;
            margin-bottom: 5px;
            font-size: 0.85em;
            border: 1px solid #ed8936;
        }

        .status-effect-item .duration {
            color: #a0a0a0;
            font-size: 0.85em;
        }

        .weapons-section {
            margin-bottom: 15px;
        }

        .weapons-section h4 {
            font-size: 0.9em;
            color: #a0a0a0;
            margin-bottom: 8px;
        }

        .weapon-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 8px;
            border-radius: 5px;
            margin-bottom: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .weapon-name {
            font-weight: 600;
            color: #e0e0e0;
        }

        .weapon-damage {
            color: #f56565;
            font-weight: bold;
        }

        .weapon-transfer {
            margin-left: 10px;
        }

        .attack-section {
            background: rgba(237, 137, 54, 0.1);
            padding: 12px;
            border-radius: 5px;
            margin-bottom: 15px;
        }

        .attack-section h4 {
            font-size: 0.9em;
            color: #ed8936;
            margin-bottom: 8px;
        }

        .attack-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .attack-controls select {
            flex: 1;
            min-width: 120px;
            padding: 8px;
            background: #1a1a2e;
            color: #e0e0e0;
            border: 1px solid #444;
            border-radius: 5px;
            font-size: 0.9em;
        }

        .attack-controls input[type="number"] {
            width: 60px;
            padding: 8px;
            background: #1a1a2e;
            color: #e0e0e0;
            border: 1px solid #444;
            border-radius: 5px;
            font-size: 0.9em;
        }

        .consumables-section {
            margin-bottom: 15px;
        }

        .consumables-section h4 {
            font-size: 0.9em;
            color: #a0a0a0;
            margin-bottom: 8px;
        }

        .consumable-item {
            background: rgba(72, 187, 120, 0.1);
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 8px;
            border-left: 3px solid #48bb78;
        }

        .consumable-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .consumable-name {
            font-weight: 600;
            color: #48bb78;
        }

        .consumable-uses {
            background: rgba(72, 187, 120, 0.2);
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 0.85em;
            font-weight: bold;
        }

        .consumable-effect {
            font-size: 0.85em;
            color: #a0a0a0;
            margin-bottom: 8px;
        }

        .consumable-actions {
            display: flex;
            gap: 5px;
        }

        .consumable-actions button {
            flex: 1;
            padding: 6px;
            font-size: 0.85em;
        }

        .consumable-actions select {
            flex: 1;
            padding: 6px;
            background: #1a1a2e;
            color: #e0e0e0;
            border: 1px solid #444;
            border-radius: 5px;
            font-size: 0.85em;
        }

        .inventory {
            margin-bottom: 15px;
        }

        .inventory h4 {
            font-size: 0.9em;
            color: #a0a0a0;
            margin-bottom: 8px;
        }

        .inventory-list {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }

        .inventory-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 5px 10px;
            border-radius: 3px;
            font-size: 0.85em;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .inventory-item button {
            background: rgba(159, 122, 234, 0.3);
            border: none;
            padding: 2px 6px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.8em;
            color: #9f7aea;
        }

        .inventory-item button:hover {
            background: rgba(159, 122, 234, 0.5);
        }

        .notes-section {
            margin-bottom: 15px;
        }

        .notes-section h4 {
            font-size: 0.9em;
            color: #a0a0a0;
            margin-bottom: 8px;
        }

        .notes-display {
            background: rgba(255, 255, 255, 0.05);
            padding: 10px;
            border-radius: 5px;
            font-size: 0.9em;
            line-height: 1.4;
            max-height: 80px;
            overflow-y: auto;
        }

        .model-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .model-actions button {
            flex: 1;
            padding: 8px;
            font-size: 0.9em;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: #1a1a1a;
            padding: 30px;
            border-radius: 10px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            border: 2px solid #FF9500;
            margin: 20px;
        }

        .modal-content h2 {
            color: #FF9500;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #9CAF88;
            font-size: 0.9em;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #FF9500;
            background: #0a0a0a;
            color: #ffffff;
            border-radius: 5px;
            font-size: 14px;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .weapons-form-section, .consumables-form-section {
            background: rgba(255, 215, 0, 0.05);
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
            border: 1px solid #FF9500;
        }

        .weapon-entry, .consumable-entry {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .weapon-entry input, .consumable-entry input, .consumable-entry select, .weapon-entry select {
            flex: 1;
            min-width: 100px;
        }

        .weapon-entry input[type="number"], .consumable-entry input[type="number"] {
            width: 100px;
            flex: 0;
        }

        .weapon-entry button, .consumable-entry button {
            padding: 8px 12px;
            flex: 0;
        }

        .form-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .form-actions button {
            flex: 1;
        }

        .status-indicator {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
            text-transform: uppercase;
        }

        .status-alive {
            background: #48bb78;
            color: white;
        }

        .status-dead {
            background: #f56565;
            color: white;
        }

        .archived-badge {
            background: #666;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            margin-left: 10px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .empty-state h3 {
            margin-bottom: 10px;
            color: #888;
        }

        .filter-controls {
            margin-bottom: 20px;
        }

        .filter-controls label {
            display: inline-flex;
            align-items: center;
            margin-right: 20px;
            cursor: pointer;
        }

        .filter-controls input[type="checkbox"] {
            margin-right: 5px;
        }

        .transfer-modal .modal-content {
            border-color: #9f7aea;
        }

        .transfer-modal h2 {
            color: #9f7aea;
        }

        .template-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .template-card {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            cursor: pointer;
            transition: all 0.3s;
        }

        .template-card:hover {
            border-color: #ff6b35;
            transform: translateY(-2px);
        }

        .template-card h4 {
            color: #ff6b35;
            margin-bottom: 5px;
        }

        .template-meta {
            font-size: 0.85em;
            color: #a0a0a0;
        }

        /* NEW 3-SECTION MODEL CARD DESIGN */
        .model-section-1 {
            background: rgba(255, 149, 0, 0.05);
            padding: 15px;
            border-bottom: 2px solid #FF9500;
        }

        .model-header-top {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }

        .model-portrait-new {
            width: 100px;
            height: 100px;
            border-radius: 8px;
            object-fit: cover;
            border: 2px solid #FF9500;
            background: #0a0a0a;
            cursor: pointer;
            transition: all 0.3s;
            flex-shrink: 0;
        }

        .model-portrait-new:hover {
            border-color: #9CAF88;
            transform: scale(1.05);
        }

        .model-header-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .model-name-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .model-name-new {
            font-size: 1.3em;
            font-weight: bold;
            color: #FF9500;
            margin: 0;
        }

        .model-stats-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            margin-top: 10px;
        }

        .model-stat-box {
            background: rgba(0, 0, 0, 0.4);
            padding: 8px 4px;
            border-radius: 5px;
            text-align: center;
            border: 1px solid #333;
        }

        .model-stat-label {
            font-size: 0.7em;
            color: #9CAF88;
            text-transform: uppercase;
            margin-bottom: 3px;
            font-weight: bold;
        }

        .model-stat-value {
            font-size: 1.1em;
            color: #FF9500;
            font-weight: bold;
        }
        
        /* Compact view adjustments */
        .model-card.compact .model-stats-grid {
            gap: 5px;
        }
        
        .model-card.compact .model-stat-box {
            padding: 6px 2px;
        }
        
        .model-card.compact .model-stat-label {
            font-size: 0.65em;
        }
        
        .model-card.compact .model-stat-value {
            font-size: 0.95em;
        }

        .model-effects-field {
            margin-top: 10px;
            padding: 8px;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 5px;
            border: 1px solid #333;
            min-height: 40px;
        }

        .model-effects-label {
            font-size: 0.75em;
            color: #9CAF88;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .model-effects-text {
            color: #ffffff;
            font-size: 0.9em;
        }

        .model-section-2 {
            background: rgba(156, 175, 136, 0.05);
            padding: 15px;
            border-bottom: 2px solid #9CAF88;
        }

        .section-title {
            font-size: 1em;
            color: #FF9500;
            margin-bottom: 10px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .special-action-item {
            background: rgba(0, 0, 0, 0.4);
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 8px;
            border-left: 3px solid #9CAF88;
        }

        .special-action-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .special-action-name {
            font-weight: bold;
            color: #9CAF88;
            font-size: 0.95em;
        }

        .special-action-uses {
            background: rgba(156, 175, 136, 0.2);
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 0.8em;
            font-weight: bold;
            color: #ffffff;
        }

        .special-action-desc {
            font-size: 0.85em;
            color: #ffffff;
            margin-bottom: 5px;
        }

        .special-action-effects {
            font-size: 0.8em;
            color: #FF9500;
        }

        .model-section-3 {
            padding: 15px;
            background: rgba(0, 0, 0, 0.2);
        }

        .equipment-grid {
            display: grid;
            gap: 10px;
        }

        .equipment-slot {
            background: rgba(255, 149, 0, 0.05);
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #FF9500;
        }

        .equipment-slot.empty {
            border-style: dashed;
            opacity: 0.5;
            text-align: center;
            color: #666;
        }

        .equipment-label {
            font-size: 0.8em;
            color: #9CAF88;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .equipment-name {
            color: #FF9500;
            font-weight: bold;
            margin-bottom: 3px;
        }

        .equipment-stats {
            font-size: 0.85em;
            color: #ffffff;
        }

        .equipment-effects {
            font-size: 0.8em;
            color: #9CAF88;
            margin-top: 3px;
        }

        .turn-status-btn {
            width: 100%;
            padding: 12px;
            font-size: 1em;
            font-weight: bold;
        }

        /* Turn Timer Styles */
        .timer-container {
            background: rgba(255, 149, 0, 0.1);
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #FF9500;
            margin-bottom: 20px;
        }

        .timer-display {
            font-size: 4em;
            font-weight: bold;
            text-align: center;
            color: #FF9500;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
        }

        .timer-display.warning {
            color: #ff4444;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .timer-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        .timer-input {
            width: 80px;
            text-align: center;
            font-size: 1.2em;
            padding: 10px;
        }

        @media (max-width: 768px) {
            .characters-grid {
                grid-template-columns: 1fr;
            }
            .characters-grid.compact {
                grid-template-columns: 1fr;
            }
            .sessions-list {
                grid-template-columns: 1fr;
            }
            .tabs {
                font-size: 12px;
            }
            .tab {
                padding: 8px 12px;
            }
        }
    </style>
</head>
<body>
    <!-- Starfield Background -->
    <div class="starfield" id="starfield"></div>

    <!-- Landing Page -->
    <div class="landing-page" id="landingPage">
        <img src="https://spaceops3030.com/cdn/shop/files/Logo_Wide_wht_c6376661-fc72-45af-ae4c-9b56e7802930.png?v=1740979952" alt="Space Ops 3030" class="landing-logo" />
        
        <div class="landing-menu">
            <button class="menu-button" onclick="selectMode('quickplay')">
                Quick Play
            </button>
            <button class="menu-button" onclick="selectMode('teambuilder')">
                Build Team
            </button>
            <button class="menu-button" onclick="selectMode('joinsession')">
                Join Session
            </button>
            <button class="menu-button" onclick="selectMode('lore')">
                Lore
            </button>
        </div>
    </div>

    <!-- App Interface (hidden initially) -->
    <div id="appInterface" style="display: none;">
    <div class="logo-header">
        <img src="https://spaceops3030.com/cdn/shop/files/Logo_Wide_wht_c6376661-fc72-45af-ae4c-9b56e7802930.png?v=1740979952" alt="Space Ops 3030" />
    </div>

    <div class="main-content">
    <div class="header">
        <h1>Tabletop Model Tracker</h1>
        
        <!-- Mission/Objectives Section -->
        <div id="missionSection" class="mission-section" style="display: none;">
            <div class="mission-header">
                <div class="mission-name editable" id="missionName" onclick="editMissionName()">Click to set mission name...</div>
                <button class="btn btn-secondary" onclick="toggleObjectives()">Objectives</button>
            </div>
            <div id="objectivesContainer" style="display: none;">
                <div class="objectives-list" id="objectivesList"></div>
                <button class="btn btn-success" style="margin-top: 10px;" onclick="addObjective()">+ Add Objective</button>
            </div>
        </div>
        
        <div class="tabs">
            <button class="tab active" onclick="switchTab('join')">Join/Create</button>
            <button class="tab" onclick="switchTab('sessions')">Sessions</button>
            <button class="tab" id="gameTabBtn" onclick="switchTab('game')" style="display: none;">Game</button>
            <button class="tab" id="toolsTabBtn" onclick="switchTab('tools')" style="display: none;">Tools</button>
            <button class="tab" id="templatesTabBtn" onclick="switchTab('templates')" style="display: none;">Templates</button>
        </div>

        <!-- Join/Create Tab -->
        <div id="joinTab" class="tab-content active">
            <div class="session-controls">
                <input type="text" id="sessionName" placeholder="Session Name (e.g., SpaceOps-Dec18)" />
                <input type="text" id="playerName" placeholder="Your Player Name" />
                <button class="btn btn-primary" onclick="joinSession()">Join Session</button>
                <button class="btn btn-secondary" onclick="showCreateSessionModal()">Create New Session</button>
            </div>
        </div>

        <!-- Sessions List Tab -->
        <div id="sessionsTab" class="tab-content">
            <div class="filter-controls">
                <label>
                    <input type="checkbox" id="showArchived" onchange="loadAllSessions()">
                    Show Archived Sessions
                </label>
            </div>
            <div id="sessionsList" class="sessions-list"></div>
        </div>

        <!-- Templates Tab -->
        <div id="templatesTab" class="tab-content">
            <div style="margin-bottom: 15px;">
                <button class="btn btn-success" onclick="openSaveTemplateModal()"> Save Current Character as Template</button>
            </div>
            <h3 style="color: #ff6b35; margin-bottom: 15px;">Character Templates</h3>
            <div id="templatesList" class="template-list"></div>
        </div>

        <!-- Current Game Tab -->
        <div id="gameTab" class="tab-content">
            <div id="sessionInfo" class="session-info">
                <div>
                    <strong>Session:</strong> <span id="currentSession"></span> | 
                    <strong>Player:</strong> <span id="currentPlayer"></span>
                </div>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="btn btn-success" onclick="showLoadTeamModal()">Load Saved Team</button>
                    <button class="btn btn-info" onclick="toggleUndoPanel()">History</button>
                    <button class="btn btn-info" onclick="toggleCombatLog()">Combat Log</button>
                    <button class="btn btn-secondary" onclick="exportSession()">Export</button>
                    <button class="btn btn-secondary" onclick="document.getElementById('importFile').click()">Import</button>
                    <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importSession(event)">
                    <button class="btn btn-secondary" onclick="leaveSession()">Leave</button>
                </div>
            </div>
            <div id="undoPanel" class="undo-section" style="display: none;">
                <h4 style="color: #4299e1; margin-bottom: 10px;">⏮ Recent Actions (Undo)</h4>
                <div id="actionHistory" class="action-history"></div>
            </div>
            <div id="combatLogPanel" class="combat-log-section" style="display: none;">
                <h4 style="color: #4299e1; margin-bottom: 10px;"> Combat Log</h4>
                <button class="btn btn-secondary" style="margin-bottom: 10px;" onclick="clearCombatLog()">Clear Log</button>
                <div id="combatLog" class="combat-log"></div>
            </div>
        </div>

        <!-- Tools Tab -->
        <div id="toolsTab" class="tab-content">
            <!-- Turn Timer -->
            <div class="timer-container">
                <h3 style="color: #FF9500; margin-bottom: 10px; text-align: center;">⏱ Turn Timer</h3>
                <div class="timer-display" id="timerDisplay">00:00</div>
                <div class="timer-controls">
                    <input type="number" id="timerMinutes" class="timer-input" placeholder="Min" min="0" max="99" value="3">
                    <input type="number" id="timerSeconds" class="timer-input" placeholder="Sec" min="0" max="59" value="0">
                    <button class="btn btn-success" onclick="startTimer()"> Start</button>
                    <button class="btn btn-warning" onclick="pauseTimer()">Pause Pause</button>
                    <button class="btn btn-danger" onclick="resetTimer()">Reset Reset</button>
                </div>
                <div style="text-align: center; margin-top: 10px; color: #9CAF88; font-size: 0.9em;" id="timerStatus">Ready</div>
            </div>

            <!-- Dice Roller -->
            <div class="dice-roller">
                <h3 style="color: #9f7aea; margin-bottom: 10px;"> Dice Roller</h3>
                <div class="dice-controls">
                    <button class="dice-btn" onclick="rollDice(4)">D4</button>
                    <button class="dice-btn" onclick="rollDice(6)">D6</button>
                    <button class="dice-btn" onclick="rollDice(8)">D8</button>
                    <button class="dice-btn" onclick="rollDice(10)">D10</button>
                    <button class="dice-btn" onclick="rollDice(12)">D12</button>
                    <button class="dice-btn" onclick="rollDice(20)">D20</button>
                    <button class="dice-btn" onclick="rollDice(100)">D100</button>
                    <input type="number" id="customDice" placeholder="Custom" style="width: 80px; padding: 10px; background: #1a1a2e; color: #e0e0e0; border: 1px solid #444; border-radius: 5px;">
                    <button class="dice-btn" onclick="rollDice(parseInt(document.getElementById('customDice').value) || 6)">Roll Custom</button>
                </div>
                <div id="diceResult" class="dice-result" style="display: none;">
                    <div class="dice-result-value"></div>
                    <div style="color: #a0a0a0; margin-top: 5px; font-size: 0.9em;"></div>
                </div>
                <div id="diceHistory" class="dice-history"></div>
            </div>

            <!-- Initiative Tracker -->
            <div class="initiative-tracker">
                <h3 style="color: #ed8936; margin-bottom: 10px;">Initiative Initiative Tracker</h3>
                <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                    <button class="btn btn-success" onclick="rollInitiativeForAll()"> Roll Initiative for All</button>
                    <button class="btn btn-warning" onclick="nextTurn()"> Next Turn</button>
                    <button class="btn btn-secondary" onclick="clearInitiative()">Clear</button>
                </div>
                <div id="initiativeList" class="initiative-list"></div>
            </div>
        </div>
    </div>

    <div id="gameArea" style="display: none;">
        <div style="margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
            <button class="btn btn-warning" onclick="showCloneSessionModal()">Clone Session</button>
            <button class="btn btn-secondary" onclick="toggleArchiveSession()"> <span id="archiveButtonText">Archive Session</span></button>
        </div>

        <!-- Team Summary Section -->
        <div id="teamsSummary" style="background: rgba(255, 149, 0, 0.1); padding: 8px 12px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #FF9500; display: none;">
            <h3 style="color: #FF9500; margin: 0 0 8px 0; font-size: 1em;">Session Overview</h3>
            <div id="teamsSummaryContent" style="display: grid; gap: 6px;"></div>
        </div>
        
        <div id="teamsContainer" class="teams-container"></div>
    </div>

    <!-- All Modals (Transfer, Create Session, Clone, Character, Status Effect, Save Template) -->
    <!-- Transfer Modal -->
    <div id="transferModal" class="modal transfer-modal">
        <div class="modal-content">
            <h2 id="transferModalTitle">Reset Transfer Item</h2>
            <p style="color: #a0a0a0; margin-bottom: 20px;">Select a character to transfer this item to:</p>
            <div class="form-group">
                <label>Recipient:</label>
                <select id="transferTarget"></select>
            </div>
            <div class="form-actions">
                <button class="btn btn-purple" onclick="confirmTransfer()">Transfer</button>
                <button class="btn btn-secondary" onclick="closeTransferModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Create Session Modal -->
    <div id="createSessionModal" class="modal">
        <div class="modal-content">
            <h2>Create New Session</h2>
            <div class="form-group">
                <label>Session Name*</label>
                <input type="text" id="newSessionName" placeholder="e.g., SpaceOps-Dec18" />
            </div>
            <div class="form-group">
                <label>Your Player Name*</label>
                <input type="text" id="newSessionPlayerName" placeholder="Your name" />
            </div>
            <div class="form-group">
                <label>Description (optional)</label>
                <textarea id="newSessionDescription" placeholder="Brief description of this session..."></textarea>
            </div>
            <div class="form-actions">
                <button type="button" class="btn btn-primary" onclick="createSession()">Create & Join</button>
                <button type="button" class="btn btn-secondary" onclick="closeCreateSessionModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Clone Session Modal -->
    <div id="cloneSessionModal" class="modal">
        <div class="modal-content">
            <h2>Clone Session</h2>
            <p style="margin-bottom: 20px; color: #a0a0a0;">Create a new session with all characters from the current session. All health will be reset to maximum.</p>
            <div class="form-group">
                <label>New Session Name*</label>
                <input type="text" id="cloneSessionName" placeholder="e.g., SpaceOps-Dec25" />
            </div>
            <div class="form-group">
                <label>Description (optional)</label>
                <textarea id="cloneSessionDescription" placeholder="Brief description..."></textarea>
            </div>
            <div class="form-actions">
                <button class="btn btn-primary" onclick="cloneSession()">Clone Session</button>
                <button class="btn btn-secondary" onclick="closeCloneSessionModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Status Effect Modal -->
    <div id="statusEffectModal" class="modal">
        <div class="modal-content">
            <h2>Add Status Effect</h2>
            <div class="form-group">
                <label>Effect Name*</label>
                <input type="text" id="statusEffectName" placeholder="e.g., Poisoned, Stunned, Buffed" />
            </div>
            <div class="form-group">
                <label>Duration (turns)</label>
                <input type="number" id="statusEffectDuration" min="1" value="3" />
            </div>
            <div class="form-group">
                <label>Description (optional)</label>
                <input type="text" id="statusEffectDesc" placeholder="e.g., -2 HP per turn" />
            </div>
            <div class="form-actions">
                <button class="btn btn-primary" onclick="confirmStatusEffect()">Add Effect</button>
                <button class="btn btn-secondary" onclick="closeStatusEffectModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Save Template Modal -->
    <div id="saveTemplateModal" class="modal">
        <div class="modal-content">
            <h2>Save Character as Template</h2>
            <p style="color: #a0a0a0; margin-bottom: 20px;">Select a character to save as a reusable template:</p>
            <div class="form-group">
                <label>Select Character:</label>
                <select id="templateCharacterSelect"></select>
            </div>
            <div class="form-group">
                <label>Template Name (optional):</label>
                <input type="text" id="templateName" placeholder="Leave blank to use character name" />
            </div>
            <div class="form-actions">
                <button class="btn btn-success" onclick="confirmSaveTemplate()">Save Template</button>
                <button class="btn btn-secondary" onclick="closeSaveTemplateModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Add/Edit Character Modal -->
    <div id="characterModal" class="modal">
        <div class="modal-content">
            <h2 id="modalTitle">Add Model</h2>
            <form id="characterForm">
                <!-- Preset Selection Section -->
                <div id="presetSelectionSection" style="background: rgba(255, 149, 0, 0.1); padding: 20px; border-radius: 10px; margin-bottom: 20px; border: 1px solid #FF9500;">
                    <h3 style="color: #FF9500; margin-top: 0;">Quick Add from Preset</h3>
                    
                    <div class="form-group">
                        <label>Step 1: Choose Faction*</label>
                        <select id="presetFactionSelect" onchange="updateModelPresets()" style="width: 100%; padding: 10px; background: rgba(0,0,0,0.5); border: 1px solid #FF9500; color: white; border-radius: 5px;">
                            <option value="">-- Select Faction --</option>
                            <option value="Arc Rangers">Arc Rangers</option>
                            <option value="Space-Wyrm">Space-Wyrm</option>
                        </select>
                    </div>
                    
                    <div class="form-group" id="presetModelGroup" style="display: none;">
                        <label>Step 2: Choose Model Type*</label>
                        <select id="presetModelSelect" onchange="fillFormFromPreset()" style="width: 100%; padding: 10px; background: rgba(0,0,0,0.5); border: 1px solid #FF9500; color: white; border-radius: 5px;">
                            <option value="">-- Select Model --</option>
                        </select>
                    </div>
                    
                    <p style="color: #9CAF88; font-size: 0.9em; margin: 10px 0 0 0;">Or scroll down to create a custom model</p>
                </div>
                
                <h3 style="color: #FF9500; margin: 20px 0 10px 0;">Model Details</h3>
                <div class="form-group">
                    <label>Character Name*</label>
                    <input type="text" id="charName" required />
                </div>
                <div class="form-group">
                    <label>Role/Class</label>
                    <input type="text" id="charRole" placeholder="e.g., Space Marine Captain" />
                </div>
                <div class="form-group">
                    <label>Portrait URL</label>
                    <input type="url" id="charPortrait" placeholder="https://..." />
                </div>
                
                <h3 style="color: #ff6b35; margin: 20px 0 10px 0;">Stats</h3>
                <div class="form-group">
                    <label>Speed</label>
                    <input type="text" id="charSpeed" placeholder="e.g., 6&quot;" />
                </div>
                <div class="form-group">
                    <label>Shoot</label>
                    <input type="text" id="charShoot" placeholder="e.g., 4+" />
                </div>
                <div class="form-group">
                    <label>Fight</label>
                    <input type="text" id="charFight" placeholder="e.g., 3+" />
                </div>
                <div class="form-group">
                    <label>Nerve</label>
                    <input type="text" id="charNerve" placeholder="e.g., 4+" />
                </div>
                <div class="form-group">
                    <label>Health*</label>
                    <input type="number" id="charHealth" required min="1" value="15" />
                </div>
                
                <div class="form-group">
                    <label>Model Color</label>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <input type="color" id="charColor" value="#FF6B6B" onchange="updateColorPreview()" style="width: 60px; height: 40px; border: none; border-radius: 5px; cursor: pointer;" />
                        <button type="button" class="btn btn-secondary" onclick="document.getElementById('charColor').value = generateRandomColor(); updateColorPreview();" style="padding: 8px 15px;">Random Color</button>
                        <div id="colorPreview" style="width: 40px; height: 40px; border-radius: 50%; background: #FF6B6B; border: 2px solid #fff;"></div>
                    </div>
                </div>

                <h3 style="color: #ff6b35; margin: 20px 0 10px 0;">Weapons</h3>
                <div class="weapons-form-section">
                    <div id="weaponsFormList"></div>
                    <button type="button" class="btn btn-success" onclick="addWeaponField()">+ Add Weapon</button>
                </div>

                <h3 style="color: #48bb78; margin: 20px 0 10px 0;">Consumable Items</h3>
                <div class="consumables-form-section">
                    <div id="consumablesFormList"></div>
                    <button type="button" class="btn btn-success" onclick="addConsumableField()">+ Add Consumable</button>
                </div>

                <h3 style="color: #FF9500; margin: 20px 0 10px 0;">Special Actions</h3>
                <div class="consumables-form-section">
                    <div id="specialActionsFormList"></div>
                    <button type="button" class="btn btn-success" onclick="addSpecialActionField()">+ Add Special Action</button>
                </div>

                <div class="form-group">
                    <label>Inventory (comma-separated)</label>
                    <textarea id="charInventory" placeholder="Medkit, Ammo, Tools"></textarea>
                </div>

                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="charNotes" placeholder="Special abilities, conditions, reminders..."></textarea>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Save Character</button>
                    <button type="button" class="btn btn-secondary" onclick="closeCharacterModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAtbd-U5_-sIoPPX8iViFmi6_-DgVD16vk",
            authDomain: "space-ops-3030.firebaseapp.com",
            databaseURL: "https://space-ops-3030-default-rtdb.firebaseio.com",
            projectId: "space-ops-3030",
            storageBucket: "space-ops-3030.firebasestorage.app",
            messagingSenderId: "905112015290",
            appId: "1:905112015290:web:0d19ac4cac33de480f4d83"
        };

        // Initialize Firebase
        let app, database, currentSession = null, currentPlayer = null;
        let editingCharacter = null;
        let weaponFields = [];
        let consumableFields = [];
        let specialActionFields = [];
        let transferData = null;
        let currentView = 'expanded'; // or 'compact' or 'tiny'
        let currentTurn = 0;
        let statusEffectTarget = null;
        let currentMode = null; // 'quickplay', 'teambuilder', 'joinsession', 'lore'

        // Game Data (Hardcoded for v12, will sync from Google Sheets in v13)
        const gameData = {
            factions: [
                {
                    name: 'Arc Rangers',
                    loreShort: 'Elite operatives defending The Reach with mobility and precision',
                    loreFull: `Arc Rangers are the elite defense force of The Reach, specializing in rapid response and precision strikes. Equipped with advanced mobility gear including jet packs and grappling systems, they excel at hit-and-run tactics. Known for their strict code of honor and unwavering dedication to protecting civilian populations against the Space-Wyrm threat and other dangers lurking in the dark corners of space.`,
                    primaryColor: '#FF9500',
                    accentColor: '#9CAF88'
                },
                {
                    name: 'Space-Wyrm',
                    loreShort: 'Ancient lunar zealots serving the Sun God, powered by solar tech',
                    loreFull: `The Space-Wyrm are an ancient bipedal lizard species from beneath the Moon's surface. Zealously devoted to their Sun God Ajj (the Ajarem - people of Ajj), they view humanity as their wayward creation that must be re-subjugated. Their technology is entirely solar-powered, making them vulnerable to overheating but deadly in sustained combat. The Sun God is cruel and unforgiving, demanding total devotion. Every Space-Wyrm passes through The Garden, a genetic mutation gate that determines their role in society. Different denominations create internal conflict even as they unite against humanity. Their battle cry: "The Sun God provides!"`,
                    primaryColor: '#FFD700',
                    accentColor: '#8B0000'
                },
                {
                    name: 'Kippin',
                    loreShort: 'Genetically engineered rebels with tech expertise and fearless tactics',
                    loreFull: `The Kippin were created by the Bazzle-Johson Corporation-State as a compliant workforce - bipedal Mustelidae (otter-like) with weasel and wolverine traits. But the "Trainables" proved anything but compliant. After learning to communicate across the Reach, they declared war on their corporate masters in 2608, reducing BazzleCorp to ash. Now free, the Kippin run extensive underground networks across 90% of space colonies. They're tech-savvy engineers and bold warriors with inherently low risk-assessment - allies must remind them to wear body armor! Known for experimental "custom" weapons, Kip-Cant sign language, and being banned from ESports for being too good. They operate successful drone pilot co-ops and street samurai gangs in Neo-Osaka. Rumor speaks of The Beach - a hidden resort using a stolen Space-Wyrm lens to create a warm sea on an ice asteroid.`,
                    primaryColor: '#10B981',
                    accentColor: '#374151'
                },
                {
                    name: 'Malegeist',
                    loreShort: 'Returned colonists corrupted by parasitic infection from deep space',
                    loreFull: `The Daedelus Expedition left Earth 300 years ago on a one-way trip to establish humanity's first exoplanet colony. They returned in 3022 as something else. The Malegeist encountered a parasitic organism in deep space that grants extended life and psionic abilities - but at a terrible cost. They can only survive by processing other organics into genetic material for sustenance. Gaunt, mutated, clad in gothic hard suits, the Malegeist infiltrate every level of corporate life in the Reach. Their philosophy: "Food has no rights." They operate in semi-autonomous fleet-pods, planning with the patience of those who have extended lifespans. The rarest Malegeist become Space Liches - neither living nor dead, neither human nor organism, shrouded in mystery and terror. Survivors of Lich encounters can never be fully trusted - are they witnesses or unwitting agents?`,
                    primaryColor: '#9333EA',
                    accentColor: '#1F2937'
                },
                {
                    name: 'Grave Kings',
                    loreShort: 'Undead remnants rising from Earth\'s blasted surface',
                    loreFull: `[Lore coming soon] The Grave Kings are necromantic forces emerging from the Blasted Earth, wielding dark powers and commanding legions of the undead.`,
                    primaryColor: '#6B7280',
                    accentColor: '#111827'
                },
                {
                    name: 'Forsaken',
                    loreShort: 'Mutated survivors struggling to endure in the wasteland',
                    loreFull: `[Lore coming soon] The Forsaken are mutated humans who survived Earth's collapse, adapting to the harsh wasteland through both biology and desperate ingenuity.`,
                    primaryColor: '#DC2626',
                    accentColor: '#450A0A'
                }
            ],
            models: [
                // Arc Rangers
                { name: 'Veteran Captain', faction: 'Arc Rangers', type: 'Captain', speed: 8, shoot: '3+', fight: '4+', nerve: '3+', health: 20, points: 40, portrait: 'https://spaceops3030.com/cdn/shop/articles/AR-with-Carbines_wide.jpg', description: 'Experienced leader with tactical expertise' },
                { name: 'Arc Ranger', faction: 'Arc Rangers', type: 'Trooper', speed: 8, shoot: '4+', fight: '5+', nerve: '4+', health: 15, points: 15, portrait: 'https://spaceops3030.com/cdn/shop/articles/AR-with-Carbines_wide.jpg', description: 'Standard operative with balanced capabilities' },
                { name: 'Scout Ranger', faction: 'Arc Rangers', type: 'Specialist', speed: 10, shoot: '4+', fight: '5+', nerve: '3+', health: 12, points: 18, portrait: 'https://spaceops3030.com/cdn/shop/articles/AR-with-Carbines_wide.jpg', description: 'Fast reconnaissance specialist' },
                { name: 'Heavy Ranger', faction: 'Arc Rangers', type: 'Specialist', speed: 6, shoot: '3+', fight: '5+', nerve: '4+', health: 18, points: 22, portrait: 'https://spaceops3030.com/cdn/shop/articles/AR-with-Carbines_wide.jpg', description: 'Armored fire support unit' },
                { name: 'Tech Specialist', faction: 'Arc Rangers', type: 'Specialist', speed: 7, shoot: '4+', fight: '5+', nerve: '4+', health: 14, points: 20, portrait: 'https://spaceops3030.com/cdn/shop/articles/AR-with-Carbines_wide.jpg', description: 'Technical expert with scanner abilities' },
                { name: 'Medic Ranger', faction: 'Arc Rangers', type: 'Specialist', speed: 7, shoot: '5+', fight: '5+', nerve: '4+', health: 14, points: 16, portrait: 'https://spaceops3030.com/cdn/shop/articles/AR-with-Carbines_wide.jpg', description: 'Field medic with healing capabilities' },
                // Space-Wyrm
                { name: 'Solar Priest', faction: 'Space-Wyrm', type: 'Leader', speed: 5, shoot: '4+', fight: '3+', nerve: '2+', health: 22, points: 45, portrait: 'https://via.placeholder.com/100/FFD700/8B0000?text=Priest', description: 'High-ranking religious commander' },
                { name: 'Wyrm Zealot', faction: 'Space-Wyrm', type: 'Warrior', speed: 6, shoot: '4+', fight: '3+', nerve: '2+', health: 18, points: 20, portrait: 'https://via.placeholder.com/100/FFD700/8B0000?text=Zealot', description: 'Fanatical Sun God devotee' },
                { name: 'Wyrm Hatchling', faction: 'Space-Wyrm', type: 'Trooper', speed: 7, shoot: '5+', fight: '4+', nerve: '3+', health: 10, points: 12, portrait: 'https://via.placeholder.com/100/FFD700/8B0000?text=Hatchling', description: 'Young warrior from The Garden' },
                { name: 'Wyrm Hunter', faction: 'Space-Wyrm', type: 'Specialist', speed: 8, shoot: '3+', fight: '4+', nerve: '3+', health: 15, points: 18, portrait: 'https://via.placeholder.com/100/FFD700/8B0000?text=Hunter', description: 'Swift ambush predator' },
                { name: 'Wyrm Brute', faction: 'Space-Wyrm', type: 'Warrior', speed: 5, shoot: '5+', fight: '2+', nerve: '2+', health: 24, points: 25, portrait: 'https://via.placeholder.com/100/FFD700/8B0000?text=Brute', description: 'Heavily mutated warrior' },
                { name: 'Solar Cultist', faction: 'Space-Wyrm', type: 'Trooper', speed: 6, shoot: '4+', fight: '4+', nerve: '3+', health: 12, points: 14, portrait: 'https://via.placeholder.com/100/FFD700/8B0000?text=Cultist', description: 'Devoted follower with basic solar weapons' }
            ],
            weapons: [
                // Arc Rangers
                { name: 'Plasma Carbine', faction: 'Arc Rangers', type: 'Ranged', attacks: 2, power: 4, damage: 2, effects: 'Rapid Fire', description: 'Standard issue energy carbine' },
                { name: 'Arc Blade', faction: 'Arc Rangers', type: 'Melee', attacks: 2, power: 3, damage: 1, effects: 'Precise', description: 'Close combat energy blade' },
                { name: 'Heavy Plasma Cannon', faction: 'Arc Rangers', type: 'Ranged', attacks: 3, power: 5, damage: 3, effects: 'Unwieldy', description: 'High-powered suppression weapon' },
                { name: 'Grapple Gun', faction: 'Arc Rangers', type: 'Equipment', attacks: 0, power: 0, damage: 0, effects: 'Mobility', description: 'Vertical movement tool' },
                { name: 'Shock Baton', faction: 'Arc Rangers', type: 'Melee', attacks: 3, power: 2, damage: 1, effects: 'Stun', description: 'Non-lethal enforcement tool' },
                { name: 'Sniper Rifle', faction: 'Arc Rangers', type: 'Ranged', attacks: 1, power: 5, damage: 3, effects: 'Long Range', description: 'Precision elimination weapon' },
                { name: 'Medkit', faction: 'Arc Rangers', type: 'Equipment', attacks: 0, power: 0, damage: 0, effects: 'Healing', description: 'Field medical equipment' },
                // Space-Wyrm
                { name: 'Thermal Lance', faction: 'Space-Wyrm', type: 'Melee', attacks: 3, power: 5, damage: 3, effects: 'Overheating', description: 'Solar-powered melee weapon' },
                { name: 'Sun Cannon', faction: 'Space-Wyrm', type: 'Ranged', attacks: 2, power: 6, damage: 4, effects: 'Blast, Overheating', description: 'Devastating solar energy weapon' },
                { name: 'Claw Gauntlets', faction: 'Space-Wyrm', type: 'Melee', attacks: 4, power: 3, damage: 1, effects: 'Rending', description: 'Enhanced natural weapons' },
                { name: 'Solar Shield', faction: 'Space-Wyrm', type: 'Equipment', attacks: 0, power: 0, damage: 0, effects: 'Defense +1', description: 'Energy shield from solar cells' },
                { name: 'Fusion Rifle', faction: 'Space-Wyrm', type: 'Ranged', attacks: 2, power: 4, damage: 2, effects: 'Solar Charge', description: 'Standard solar ranged weapon' },
                { name: 'Burning Blade', faction: 'Space-Wyrm', type: 'Melee', attacks: 2, power: 4, damage: 2, effects: 'Ignite', description: 'Superheated blade weapon' },
                { name: 'Prayer Beads', faction: 'Space-Wyrm', type: 'Equipment', attacks: 0, power: 0, damage: 0, effects: 'Faith', description: 'Religious icon for morale' }
            ],
            specialActions: [
                // Arc Rangers
                { name: 'Jump Boost', faction: 'Arc Rangers', description: 'Uses jet pack to boost 6 inches. Ignores terrain.', effects: 'Dangerous terrain test required', maxUses: 1, type: 'Movement' },
                { name: 'Tactical Scanner', faction: 'Arc Rangers', description: 'Reveal enemy positions and weaknesses.', effects: 'Squad +1 to hit this turn', maxUses: 2, type: 'Support' },
                { name: 'Suppressing Fire', faction: 'Arc Rangers', description: 'Pin enemy units with sustained fire.', effects: 'Enemy -1 movement this turn', maxUses: 3, type: 'Combat' },
                { name: 'Emergency Evac', faction: 'Arc Rangers', description: 'Rapid extraction from danger zone.', effects: 'Remove from danger', maxUses: 1, type: 'Movement' },
                { name: 'Overwatch Protocol', faction: 'Arc Rangers', description: 'Enhanced defensive reaction fire.', effects: 'Free interrupt shot', maxUses: 2, type: 'Defense' },
                { name: 'Medic Stabilize', faction: 'Arc Rangers', description: 'Advanced field medicine.', effects: 'Restore D3 health to ally', maxUses: 2, type: 'Support' },
                // Space-Wyrm
                { name: 'Solar Frenzy', faction: 'Space-Wyrm', description: 'Channel Sun God wrath for extra attacks.', effects: '+2 attacks, risk Overheating', maxUses: 2, type: 'Combat' },
                { name: 'Divine Vision', faction: 'Space-Wyrm', description: 'Heat-induced prophetic guidance.', effects: 'Re-roll one failed test', maxUses: 1, type: 'Support' },
                { name: 'Hatchery Rage', faction: 'Space-Wyrm', description: 'Primal berserker fury from hatchery memories.', effects: '+3 attacks, -1 defense for 2 turns', maxUses: 1, type: 'Combat' },
                { name: 'Solar Surge', faction: 'Space-Wyrm', description: 'Overload solar cells for power boost.', effects: '+1 to all solar weapons this turn', maxUses: 2, type: 'Combat' },
                { name: 'Zealot\'s Prayer', faction: 'Space-Wyrm', description: 'Invoke Sun God protection.', effects: 'Ignore next wound on Nerve test', maxUses: 2, type: 'Defense' },
                { name: 'Thermal Vent', faction: 'Space-Wyrm', description: 'Emergency heat dissipation.', effects: 'Remove Overheating status', maxUses: 3, type: 'Support' }
            ]
        };

        // Preset Items Library (keeping for backwards compatibility)
        const presetWeapons = [
            { name: 'Plasma Pistol', type: 'Ranged', attacks: 2, power: 3, damage: 2 },
            { name: 'Bolter', type: 'Ranged', attacks: 3, power: 2, damage: 1 },
            { name: 'Heavy Bolter', type: 'Ranged', attacks: 4, power: 3, damage: 2 },
            { name: 'Chainsword', type: 'Melee', attacks: 3, power: 2, damage: 1 },
            { name: 'Power Fist', type: 'Melee', attacks: 2, power: 4, damage: 3 },
            { name: 'Krak Grenade', type: 'Ranged', attacks: 1, power: 4, damage: 3 },
            { name: 'Frag Grenade', type: 'Ranged', attacks: 3, power: 2, damage: 1 },
            { name: 'Melta Gun', type: 'Ranged', attacks: 1, power: 5, damage: 4 },
            { name: 'Lasgun', type: 'Ranged', attacks: 2, power: 1, damage: 1 },
            { name: 'Bolt Rifle', type: 'Ranged', attacks: 2, power: 2, damage: 1 },
            { name: 'Storm Bolter', type: 'Ranged', attacks: 4, power: 2, damage: 1 },
            { name: 'Combat Knife', type: 'Melee', attacks: 2, power: 1, damage: 1 },
            { name: 'Sniper Rifle', type: 'Ranged', attacks: 1, power: 3, damage: 2 },
            { name: 'Shotgun', type: 'Ranged', attacks: 2, power: 2, damage: 1 },
            { name: 'Assault Rifle', type: 'Ranged', attacks: 3, power: 2, damage: 1 }
        ];

        const presetConsumables = [
            { name: 'Medkit', effect: 'heal', amount: 5, maxUses: 2, targetType: 'self' },
            { name: 'Healing Potion', effect: 'heal', amount: 3, maxUses: 3, targetType: 'self' },
            { name: 'Emergency Stim', effect: 'heal', amount: 3, maxUses: 1, targetType: 'other' },
            { name: 'Combat Stim', effect: 'buff', amount: 2, maxUses: 1, targetType: 'self' },
            { name: 'Poison Vial', effect: 'damage', amount: 4, maxUses: 2, targetType: 'other' },
            { name: 'Field Bandage', effect: 'heal', amount: 2, maxUses: 5, targetType: 'self' },
            { name: 'Adrenaline Shot', effect: 'buff', amount: 3, maxUses: 1, targetType: 'self' },
            { name: 'Flashbang', effect: 'damage', amount: 2, maxUses: 3, targetType: 'other' },
            { name: 'Health Pack', effect: 'heal', amount: 8, maxUses: 1, targetType: 'self' },
            { name: 'Smoke Grenade', effect: 'buff', amount: 1, maxUses: 2, targetType: 'self' }
        ];

        try {
            app = firebase.initializeApp(firebaseConfig);
            database = firebase.database();
        } catch (error) {
            console.error("Firebase initialization error:", error);
            alert("Firebase initialization failed. Please check the console.");
        }

        // Dice Roller
        let diceHistory = [];
        
        function rollDice(sides) {
            const result = Math.floor(Math.random() * sides) + 1;
            const timestamp = new Date().toLocaleTimeString();
            diceHistory.unshift({ sides, result, timestamp });
            if (diceHistory.length > 10) diceHistory.pop();
            
            const resultDiv = document.getElementById('diceResult');
            resultDiv.style.display = 'block';
            resultDiv.querySelector('.dice-result-value').textContent = result;
            resultDiv.querySelector('div:last-child').textContent = `D${sides} rolled at ${timestamp}`;
            
            updateDiceHistory();
            logToCombat(` Rolled D${sides}: ${result}`);
        }
        
        function updateDiceHistory() {
            const container = document.getElementById('diceHistory');
            container.innerHTML = diceHistory.map(h => 
                `<div class="dice-history-item">D${h.sides}: ${h.result} (${h.timestamp})</div>`
            ).join('');
        }

        // Initiative Tracker
        function rollInitiativeForAll() {
            if (!currentSession) return;
            
            const sessionRef = database.ref(`sessions/${currentSession}/teams`);
            sessionRef.once('value', (snapshot) => {
                const teams = snapshot.val() || {};
                const initiatives = [];
                
                Object.entries(teams).forEach(([teamId, team]) => {
                    if (team.characters) {
                        Object.entries(team.characters).forEach(([charId, char]) => {
                            if (char.status === 'alive') {
                                const roll = Math.floor(Math.random() * 20) + 1;
                                initiatives.push({
                                    teamId,
                                    charId,
                                    name: char.name,
                                    owner: team.owner,
                                    initiative: roll
                                });
                            }
                        });
                    }
                });
                
                initiatives.sort((a, b) => b.initiative - a.initiative);
                
                database.ref(`sessions/${currentSession}/initiative`).set({
                    order: initiatives,
                    currentTurn: 0
                });
                
                renderInitiative();
                logToCombat('Initiative Initiative rolled for all characters');
            });
        }
        
        function renderInitiative() {
            const initiativeRef = database.ref(`sessions/${currentSession}/initiative`);
            initiativeRef.on('value', (snapshot) => {
                const data = snapshot.val();
                if (!data || !data.order) {
                    document.getElementById('initiativeList').innerHTML = '<div style="text-align: center; color: #666;">No initiative rolled yet</div>';
                    return;
                }
                
                const container = document.getElementById('initiativeList');
                currentTurn = data.currentTurn || 0;
                
                container.innerHTML = data.order.map((char, idx) => `
                    <div class="initiative-item ${idx === currentTurn ? 'active-turn' : ''}">
                        <div class="initiative-number">${char.initiative}</div>
                        <div class="initiative-char">${char.owner} - ${char.name}</div>
                        ${idx === currentTurn ? '<span style="color: #48bb78; font-weight: bold;"> Current Turn</span>' : ''}
                    </div>
                `).join('');
            });
        }
        
        function nextTurn() {
            const initiativeRef = database.ref(`sessions/${currentSession}/initiative`);
            initiativeRef.once('value', (snapshot) => {
                const data = snapshot.val();
                if (!data || !data.order) return;
                
                const newTurn = (data.currentTurn + 1) % data.order.length;
                initiativeRef.update({ currentTurn: newTurn });
                
                // Decrease status effect durations
                decreaseStatusEffectDurations();
                
                logToCombat(` Turn passed to ${data.order[newTurn].name}`);
            });
        }
        
        function clearInitiative() {
            if (confirm('Clear initiative order?')) {
                database.ref(`sessions/${currentSession}/initiative`).remove();
                logToCombat('Initiative Initiative cleared');
            }
        }
        
        function decreaseStatusEffectDurations() {
            const sessionRef = database.ref(`sessions/${currentSession}/teams`);
            sessionRef.once('value', (snapshot) => {
                const teams = snapshot.val() || {};
                
                Object.entries(teams).forEach(([teamId, team]) => {
                    if (team.characters) {
                        Object.entries(team.characters).forEach(([charId, char]) => {
                            if (char.statusEffects && char.statusEffects.length > 0) {
                                const updated = char.statusEffects.map(effect => ({
                                    ...effect,
                                    duration: effect.duration - 1
                                })).filter(effect => effect.duration > 0);
                                
                                database.ref(`sessions/${currentSession}/teams/${teamId}/characters/${charId}`).update({
                                    statusEffects: updated
                                });
                            }
                        });
                    }
                });
            });
        }

        // Status Effects
        function openStatusEffectModal(teamId, charId) {
            statusEffectTarget = { teamId, charId };
            document.getElementById('statusEffectModal').classList.add('active');
        }
        
        function closeStatusEffectModal() {
            document.getElementById('statusEffectModal').classList.remove('active');
            statusEffectTarget = null;
        }
        
        function confirmStatusEffect() {
            const name = document.getElementById('statusEffectName').value.trim();
            const duration = parseInt(document.getElementById('statusEffectDuration').value);
            const description = document.getElementById('statusEffectDesc').value.trim();
            
            if (!name) {
                alert('Please enter an effect name');
                return;
            }
            
            const { teamId, charId } = statusEffectTarget;
            const charRef = database.ref(`sessions/${currentSession}/teams/${teamId}/characters/${charId}`);
            
            charRef.once('value', (snapshot) => {
                const char = snapshot.val();
                const statusEffects = char.statusEffects || [];
                statusEffects.push({ name, duration, description });
                charRef.update({ statusEffects });
                
                logToCombat(` ${char.name} gained status: ${name} (${duration} turns)`);
            });
            
            document.getElementById('statusEffectName').value = '';
            document.getElementById('statusEffectDuration').value = '3';
            document.getElementById('statusEffectDesc').value = '';
            closeStatusEffectModal();
        }
        
        function removeStatusEffect(teamId, charId, effectIndex) {
            const charRef = database.ref(`sessions/${currentSession}/teams/${teamId}/characters/${charId}`);
            charRef.once('value', (snapshot) => {
                const char = snapshot.val();
                const statusEffects = char.statusEffects || [];
                const removed = statusEffects.splice(effectIndex, 1)[0];
                charRef.update({ statusEffects });
                
                logToCombat(` ${char.name} lost status: ${removed.name}`);
            });
        }

        // Combat Log
        function logToCombat(message) {
            if (!currentSession) return;
            
            const logRef = database.ref(`sessions/${currentSession}/combatLog`);
            logRef.push({
                message: message,
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                player: currentPlayer
            });
        }
        
        function toggleCombatLog() {
            const panel = document.getElementById('combatLogPanel');
            if (panel.style.display === 'none') {
                panel.style.display = 'block';
                loadCombatLog();
            } else {
                panel.style.display = 'none';
            }
        }
        
        function loadCombatLog() {
            const logRef = database.ref(`sessions/${currentSession}/combatLog`);
            logRef.orderByChild('timestamp').limitToLast(50).on('value', (snapshot) => {
                const container = document.getElementById('combatLog');
                const logs = [];
                snapshot.forEach((child) => {
                    logs.push({ key: child.key, ...child.val() });
                });
                
                logs.reverse();
                container.innerHTML = logs.map(log => {
                    const time = new Date(log.timestamp).toLocaleTimeString();
                    return `
                        <div class="log-item">
                            <span class="log-text">${log.message}</span>
                            <span class="log-time">${time}</span>
                        </div>
                    `;
                }).join('');
                
                if (logs.length === 0) {
                    container.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">No combat actions yet</div>';
                }
            });
        }
        
        function clearCombatLog() {
            if (confirm('Clear combat log?')) {
                database.ref(`sessions/${currentSession}/combatLog`).remove();
            }
        }

        // Export/Import
        function exportSession() {
            const sessionRef = database.ref(`sessions/${currentSession}`);
            sessionRef.once('value', (snapshot) => {
                const data = snapshot.val();
                const json = JSON.stringify(data, null, 2);
                const blob = new Blob([json], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${currentSession}-export.json`;
                a.click();
                URL.revokeObjectURL(url);
            });
        }
        
        function importSession(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    const newName = prompt('Enter a name for the imported session:', data.name + '-imported');
                    if (!newName) return;
                    
                    database.ref(`sessions/${newName}`).set({
                        ...data,
                        name: newName,
                        created: firebase.database.ServerValue.TIMESTAMP
                    }).then(() => {
                        alert('Session imported successfully!');
                        loadAllSessions();
                    });
                } catch (error) {
                    alert('Failed to import session. Invalid file format.');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        // Templates
        function openSaveTemplateModal() {
            if (!currentSession) {
                alert('Please join a session first');
                return;
            }
            
            const sessionRef = database.ref(`sessions/${currentSession}/teams`);
            sessionRef.once('value', (snapshot) => {
                const teams = snapshot.val() || {};
                const select = document.getElementById('templateCharacterSelect');
                select.innerHTML = '<option value="">Select a character...</option>';
                
                Object.entries(teams).forEach(([teamId, team]) => {
                    if (team.characters) {
                        Object.entries(team.characters).forEach(([charId, char]) => {
                            select.innerHTML += `<option value="${teamId}:${charId}">${team.owner} - ${char.name}</option>`;
                        });
                    }
                });
            });
            
            document.getElementById('saveTemplateModal').classList.add('active');
        }
        
        function closeSaveTemplateModal() {
            document.getElementById('saveTemplateModal').classList.remove('active');
        }
        
        function confirmSaveTemplate() {
            const select = document.getElementById('templateCharacterSelect');
            const templateName = document.getElementById('templateName').value.trim();
            
            if (!select.value) {
                alert('Please select a character');
                return;
            }
            
            const [teamId, charId] = select.value.split(':');
            const charRef = database.ref(`sessions/${currentSession}/teams/${teamId}/characters/${charId}`);
            
            charRef.once('value', (snapshot) => {
                const char = snapshot.val();
                const template = {
                    ...char,
                    templateName: templateName || char.name,
                    created: firebase.database.ServerValue.TIMESTAMP,
                    creator: currentPlayer
                };
                
                database.ref('templates').push(template).then(() => {
                    alert('Template saved!');
                    closeSaveTemplateModal();
                    loadTemplates();
                });
            });
        }
        
        function loadTemplates() {
            const templatesRef = database.ref('templates');
            templatesRef.on('value', (snapshot) => {
                const templates = snapshot.val() || {};
                const container = document.getElementById('templatesList');
                
                if (Object.keys(templates).length === 0) {
                    container.innerHTML = '<div class="empty-state"><h3>No templates yet</h3><p>Save a character as a template to reuse it</p></div>';
                    return;
                }
                
                container.innerHTML = '';
                Object.entries(templates).forEach(([key, template]) => {
                    const card = document.createElement('div');
                    card.className = 'template-card';
                    card.style.position = 'relative';
                    card.innerHTML = `
                        ${template.portrait ? `
                            <div style="width: 100%; height: 150px; background-image: url('${template.portrait}'); background-size: cover; background-position: center; border-radius: 8px 8px 0 0; margin: -15px -15px 15px -15px;"></div>
                        ` : ''}
                        <button onclick="event.stopPropagation(); deleteTemplate('${key}', '${template.templateName || template.name}');" 
                                style="position: absolute; top: 10px; right: 10px; background: rgba(220, 38, 38, 0.9); color: white; border: none; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; font-size: 18px; display: flex; align-items: center; justify-content: center; z-index: 10;"
                                title="Delete Template">×</button>
                        <h4 style="margin-top: ${template.portrait ? '0' : '0'};">${template.templateName || template.name}</h4>
                        <div class="template-meta">
                            Role: ${template.role || 'N/A'}<br>
                            Health: ${template.maxHealth}<br>
                            ${template.speed ? `Speed: ${template.speed}<br>` : ''}
                            ${template.shoot ? `Shoot: ${template.shoot}<br>` : ''}
                            ${template.fight ? `Fight: ${template.fight}<br>` : ''}
                            By: ${template.creator}
                        </div>
                    `;
                    card.onclick = () => useTemplate(key, template);
                    container.appendChild(card);
                });
            });
        }
        
        function deleteTemplate(key, name) {
            if (confirm(`Delete template "${name}"? This cannot be undone.`)) {
                database.ref(`templates/${key}`).remove().then(() => {
                    alert('Template deleted successfully!');
                }).catch(error => {
                    alert('Error deleting template: ' + error.message);
                });
            }
        }
        
        function useTemplate(key, template) {
            if (!currentSession) {
                alert('Please join a session first');
                return;
            }
            
            if (!confirm(`Use template "${template.templateName || template.name}"?`)) return;
            
            const character = {
                ...template,
                currentHealth: template.maxHealth,
                status: 'alive',
                owner: currentPlayer,
                statusEffects: [],
                consumables: template.consumables ? template.consumables.map(c => ({ ...c, uses: c.maxUses })) : []
            };
            
            delete character.templateName;
            delete character.created;
            delete character.creator;
            
            const teamId = currentPlayer.replace(/\s/g, '_');
            const charId = 'char_' + Date.now();
            const teamRef = database.ref(`sessions/${currentSession}/teams/${teamId}`);
            
            teamRef.once('value', (snapshot) => {
                if (snapshot.exists()) {
                    teamRef.child('characters/' + charId).set(character);
                } else {
                    teamRef.set({
                        owner: currentPlayer,
                        characters: {
                            [charId]: character
                        }
                    });
                }
                alert('Character created from template!');
                switchTab('game');
            });
        }

        // View Toggle
        function toggleView(view) {
            currentView = view;
            renderTeams();
        }

        // Item Transfer System
        function openTransferModal(fromTeamId, fromCharId, itemType, itemIndex, itemName) {
            transferData = { fromTeamId, fromCharId, itemType, itemIndex, itemName };
            
            document.getElementById('transferModalTitle').textContent = `Reset Transfer: ${itemName}`;
            
            const sessionRef = database.ref(`sessions/${currentSession}/teams`);
            sessionRef.once('value', (snapshot) => {
                const teams = snapshot.val() || {};
                const targetSelect = document.getElementById('transferTarget');
                targetSelect.innerHTML = '<option value="">Select character...</option>';
                
                Object.entries(teams).forEach(([teamId, team]) => {
                    if (team.characters) {
                        Object.entries(team.characters).forEach(([charId, char]) => {
                            if (char.status === 'alive' && !(teamId === fromTeamId && charId === fromCharId)) {
                                targetSelect.innerHTML += `<option value="${teamId}:${charId}">${team.owner} - ${char.name}</option>`;
                            }
                        });
                    }
                });
            });
            
            document.getElementById('transferModal').classList.add('active');
        }

        function closeTransferModal() {
            document.getElementById('transferModal').classList.remove('active');
            transferData = null;
        }

        function confirmTransfer() {
            const targetValue = document.getElementById('transferTarget').value;
            if (!targetValue) {
                alert('Please select a recipient');
                return;
            }
            
            const [toTeamId, toCharId] = targetValue.split(':');
            const { fromTeamId, fromCharId, itemType, itemIndex, itemName } = transferData;
            
            const fromCharRef = database.ref(`sessions/${currentSession}/teams/${fromTeamId}/characters/${fromCharId}`);
            const toCharRef = database.ref(`sessions/${currentSession}/teams/${toTeamId}/characters/${toCharId}`);
            
            Promise.all([
                fromCharRef.once('value'),
                toCharRef.once('value')
            ]).then(([fromSnapshot, toSnapshot]) => {
                const fromChar = fromSnapshot.val();
                const toChar = toSnapshot.val();
                
                let itemToTransfer = null;
                
                if (itemType === 'weapon') {
                    itemToTransfer = fromChar.weapons[itemIndex];
                    fromChar.weapons.splice(itemIndex, 1);
                    toChar.weapons = toChar.weapons || [];
                    toChar.weapons.push(itemToTransfer);
                } else if (itemType === 'consumable') {
                    itemToTransfer = fromChar.consumables[itemIndex];
                    fromChar.consumables.splice(itemIndex, 1);
                    toChar.consumables = toChar.consumables || [];
                    toChar.consumables.push(itemToTransfer);
                } else if (itemType === 'inventory') {
                    itemToTransfer = fromChar.inventory[itemIndex];
                    fromChar.inventory.splice(itemIndex, 1);
                    toChar.inventory = toChar.inventory || [];
                    toChar.inventory.push(itemToTransfer);
                }
                
                fromCharRef.update({ 
                    weapons: fromChar.weapons || [],
                    consumables: fromChar.consumables || [],
                    inventory: fromChar.inventory || []
                });
                toCharRef.update({ 
                    weapons: toChar.weapons || [],
                    consumables: toChar.consumables || [],
                    inventory: toChar.inventory || []
                });
                
                logAction(`${fromChar.name} transferred ${itemName} to ${toChar.name}`, {
                    type: 'itemTransfer',
                    fromTeamId, fromCharId, toTeamId, toCharId, itemType, item: itemToTransfer
                });
                
                logToCombat(`Reset ${fromChar.name} → ${toChar.name}: ${itemName}`);
                
                closeTransferModal();
            });
        }

        // Action History System
        function logAction(description, undoAction) {
            if (!currentSession) return;
            
            const actionRef = database.ref(`sessions/${currentSession}/actionHistory`);
            const newAction = {
                description: description,
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                player: currentPlayer,
                undoData: undoAction
            };
            
            actionRef.push(newAction);
        }

        function toggleUndoPanel() {
            const panel = document.getElementById('undoPanel');
            if (panel.style.display === 'none') {
                panel.style.display = 'block';
                loadActionHistory();
            } else {
                panel.style.display = 'none';
            }
        }

        function loadActionHistory() {
            const actionRef = database.ref(`sessions/${currentSession}/actionHistory`);
            actionRef.orderByChild('timestamp').limitToLast(10).once('value', (snapshot) => {
                const container = document.getElementById('actionHistory');
                container.innerHTML = '';
                
                const actions = [];
                snapshot.forEach((child) => {
                    actions.push({ key: child.key, ...child.val() });
                });
                
                actions.reverse().forEach((action) => {
                    const timestamp = new Date(action.timestamp).toLocaleTimeString();
                    const actionDiv = document.createElement('div');
                    actionDiv.className = 'action-item';
                    actionDiv.innerHTML = `
                        <span class="action-text">${action.description}</span>
                        <span class="action-time">${timestamp}</span>
                        <button class="btn btn-secondary" style="padding: 5px 10px; font-size: 0.85em;" onclick="undoAction('${action.key}', ${JSON.stringify(action.undoData).replace(/"/g, '&quot;')})">Undo</button>
                    `;
                    container.appendChild(actionDiv);
                });
                
                if (actions.length === 0) {
                    container.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">No recent actions</div>';
                }
            });
        }

        function undoAction(actionKey, undoData) {
            if (!confirm('Undo this action?')) return;
            
            if (undoData.type === 'healthChange') {
                const charRef = database.ref(`sessions/${currentSession}/teams/${undoData.teamId}/characters/${undoData.charId}`);
                charRef.once('value', (snapshot) => {
                    const char = snapshot.val();
                    const newHealth = Math.max(0, Math.min(char.maxHealth, char.currentHealth - undoData.change));
                    charRef.update({
                        currentHealth: newHealth,
                        status: newHealth > 0 ? 'alive' : 'dead'
                    });
                });
            } else if (undoData.type === 'consumableUse') {
                const charRef = database.ref(`sessions/${currentSession}/teams/${undoData.teamId}/characters/${undoData.charId}`);
                charRef.once('value', (snapshot) => {
                    const char = snapshot.val();
                    if (char.consumables && char.consumables[undoData.consumableIndex]) {
                        const consumables = [...char.consumables];
                        consumables[undoData.consumableIndex].uses += 1;
                        charRef.update({ consumables });
                    }
                    
                    if (undoData.healthChange && undoData.targetTeamId && undoData.targetCharId) {
                        const targetRef = database.ref(`sessions/${currentSession}/teams/${undoData.targetTeamId}/characters/${undoData.targetCharId}`);
                        targetRef.once('value', (targetSnapshot) => {
                            const targetChar = targetSnapshot.val();
                            const newHealth = Math.max(0, Math.min(targetChar.maxHealth, targetChar.currentHealth - undoData.healthChange));
                            targetRef.update({
                                currentHealth: newHealth,
                                status: newHealth > 0 ? 'alive' : 'dead'
                            });
                        });
                    }
                });
            } else if (undoData.type === 'itemTransfer') {
                const fromCharRef = database.ref(`sessions/${currentSession}/teams/${undoData.fromTeamId}/characters/${undoData.fromCharId}`);
                const toCharRef = database.ref(`sessions/${currentSession}/teams/${undoData.toTeamId}/characters/${undoData.toCharId}`);
                
                Promise.all([
                    fromCharRef.once('value'),
                    toCharRef.once('value')
                ]).then(([fromSnapshot, toSnapshot]) => {
                    const fromChar = fromSnapshot.val();
                    const toChar = toSnapshot.val();
                    
                    if (undoData.itemType === 'weapon') {
                        const idx = toChar.weapons.findIndex(w => JSON.stringify(w) === JSON.stringify(undoData.item));
                        if (idx !== -1) {
                            toChar.weapons.splice(idx, 1);
                            fromChar.weapons.push(undoData.item);
                        }
                    } else if (undoData.itemType === 'consumable') {
                        const idx = toChar.consumables.findIndex(c => c.name === undoData.item.name);
                        if (idx !== -1) {
                            toChar.consumables.splice(idx, 1);
                            fromChar.consumables.push(undoData.item);
                        }
                    } else if (undoData.itemType === 'inventory') {
                        const idx = toChar.inventory.indexOf(undoData.item);
                        if (idx !== -1) {
                            toChar.inventory.splice(idx, 1);
                            fromChar.inventory.push(undoData.item);
                        }
                    }
                    
                    fromCharRef.update({ 
                        weapons: fromChar.weapons || [],
                        consumables: fromChar.consumables || [],
                        inventory: fromChar.inventory || []
                    });
                    toCharRef.update({ 
                        weapons: toChar.weapons || [],
                        consumables: toChar.consumables || [],
                        inventory: toChar.inventory || []
                    });
                });
            }
            
            database.ref(`sessions/${currentSession}/actionHistory/${actionKey}`).remove();
            loadActionHistory();
        }

        // Tab switching
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            if (tabName === 'join') {
                document.querySelector('.tab:nth-child(1)').classList.add('active');
                document.getElementById('joinTab').classList.add('active');
            } else if (tabName === 'sessions') {
                document.querySelector('.tab:nth-child(2)').classList.add('active');
                document.getElementById('sessionsTab').classList.add('active');
                loadAllSessions();
            } else if (tabName === 'game') {
                document.querySelector('.tab:nth-child(3)').classList.add('active');
                document.getElementById('gameTab').classList.add('active');
            } else if (tabName === 'tools') {
                document.querySelector('.tab:nth-child(4)').classList.add('active');
                document.getElementById('toolsTab').classList.add('active');
                renderInitiative();
            } else if (tabName === 'templates') {
                document.querySelector('.tab:nth-child(5)').classList.add('active');
                document.getElementById('templatesTab').classList.add('active');
                loadTemplates();
            }
        }

        // Session Management
        function showCreateSessionModal() {
            document.getElementById('createSessionModal').classList.add('active');
        }

        function closeCreateSessionModal() {
            document.getElementById('createSessionModal').classList.remove('active');
        }

        function createSession() {
            const sessionName = document.getElementById('newSessionName').value.trim();
            const description = document.getElementById('newSessionDescription').value.trim();
            const playerName = document.getElementById('newSessionPlayerName').value.trim();

            if (!sessionName) {
                alert('Please enter a session name');
                return;
            }

            if (!playerName) {
                alert('Please enter your player name');
                return;
            }

            const sessionRef = database.ref('sessions/' + sessionName);
            sessionRef.once('value', (snapshot) => {
                if (snapshot.exists()) {
                    alert('A session with this name already exists. Please choose a different name.');
                    return;
                }

                sessionRef.set({
                    name: sessionName,
                    description: description,
                    created: firebase.database.ServerValue.TIMESTAMP,
                    archived: false,
                    teams: {},
                    actionHistory: {},
                    combatLog: {},
                    initiative: {}
                }).then(() => {
                    // Set values in main interface
                    document.getElementById('sessionName').value = sessionName;
                    document.getElementById('playerName').value = playerName;
                    
                    closeCreateSessionModal();
                    joinSession();
                });
            });
        }

        function joinSession() {
            const sessionName = document.getElementById('sessionName').value.trim();
            const playerName = document.getElementById('playerName').value.trim();

            if (!sessionName) {
                alert('Please enter a Session Name');
                return;
            }

            if (!playerName) {
                alert('Please enter your player name');
                return;
            }

            const sessionRef = database.ref('sessions/' + sessionName);
            sessionRef.once('value', (snapshot) => {
                if (!snapshot.exists()) {
                    alert('Session not found. Please create it first or check the name.');
                    return;
                }

                currentSession = sessionName;
                currentPlayer = playerName;
                
                // Save player name for next time
                localStorage.setItem('lastPlayerName', playerName);

                document.getElementById('currentSession').textContent = sessionName;
                document.getElementById('currentPlayer').textContent = playerName;
                document.getElementById('gameTabBtn').style.display = 'block';
                document.getElementById('toolsTabBtn').style.display = 'block';
                document.getElementById('templatesTabBtn').style.display = 'block';
                document.getElementById('gameArea').style.display = 'block';

                // Load mission and objectives
                loadMissionObjectives();
                
                // Sync turn timer
                syncTimer();

                switchTab('game');

                const archived = snapshot.val().archived || false;
                document.getElementById('archiveButtonText').textContent = archived ? 'Unarchive Session' : 'Archive Session';

                sessionRef.child('teams').on('value', (snapshot) => {
                    renderTeams(snapshot.val() || {});
                });
            });
        }

        function leaveSession() {
            if (currentSession) {
                const sessionRef = database.ref('sessions/' + currentSession + '/teams');
                sessionRef.off();
            }

            currentSession = null;
            currentPlayer = null;
            document.getElementById('gameTabBtn').style.display = 'none';
            document.getElementById('toolsTabBtn').style.display = 'none';
            document.getElementById('gameArea').style.display = 'none';
            document.getElementById('sessionName').value = '';
            document.getElementById('teamsContainer').innerHTML = '';
            
            switchTab('join');
        }

        function loadAllSessions() {
            const showArchived = document.getElementById('showArchived').checked;
            const sessionsRef = database.ref('sessions');
            
            sessionsRef.once('value', (snapshot) => {
                const sessions = snapshot.val() || {};
                const container = document.getElementById('sessionsList');
                container.innerHTML = '';

                const sessionsList = Object.entries(sessions)
                    .filter(([_, session]) => showArchived || !session.archived)
                    .sort((a, b) => (b[1].created || 0) - (a[1].created || 0));

                if (sessionsList.length === 0) {
                    container.innerHTML = '<div class="empty-state"><h3>No sessions found</h3><p>Create your first session to get started</p></div>';
                    return;
                }

                sessionsList.forEach(([sessionName, session]) => {
                    const card = document.createElement('div');
                    card.className = 'session-card' + (session.archived ? ' archived' : '');
                    
                    const created = session.created ? new Date(session.created).toLocaleDateString() : 'Unknown';
                    const teamCount = session.teams ? Object.keys(session.teams).length : 0;
                    const charCount = session.teams ? Object.values(session.teams).reduce((sum, team) => {
                        return sum + (team.characters ? Object.keys(team.characters).length : 0);
                    }, 0) : 0;

                    card.innerHTML = `
                        <h3>${sessionName} ${session.archived ? '<span class="archived-badge">ARCHIVED</span>' : ''}</h3>
                        <div class="session-meta">
                             Created: ${created}<br>
                             ${teamCount} team(s), ${charCount} character(s)<br>
                            ${session.description ? ` ${session.description}` : ''}
                        </div>
                        <div class="session-actions">
                            <button class="btn btn-primary" onclick="joinSessionByName('${sessionName}')">Join</button>
                            <button class="btn btn-warning" onclick="cloneSessionByName('${sessionName}')">Clone</button>
                            <button class="btn btn-danger" onclick="deleteSessionByName('${sessionName}')">Delete</button>
                        </div>
                    `;
                    
                    container.appendChild(card);
                });
            });
        }

        function joinSessionByName(sessionName) {
            const playerName = document.getElementById('playerName').value.trim() || 'Player';
            document.getElementById('sessionName').value = sessionName;
            document.getElementById('playerName').value = playerName;
            joinSession();
        }

        function deleteSessionByName(sessionName) {
            if (confirm(`Are you sure you want to permanently delete session "${sessionName}"? This cannot be undone.`)) {
                database.ref('sessions/' + sessionName).remove().then(() => {
                    loadAllSessions();
                });
            }
        }

        function toggleArchiveSession() {
            if (!currentSession) return;

            const sessionRef = database.ref('sessions/' + currentSession);
            sessionRef.once('value', (snapshot) => {
                const session = snapshot.val();
                const newArchivedState = !session.archived;
                
                sessionRef.update({ archived: newArchivedState }).then(() => {
                    document.getElementById('archiveButtonText').textContent = newArchivedState ? 'Unarchive Session' : 'Archive Session';
                    alert(newArchivedState ? 'Session archived' : 'Session unarchived');
                });
            });
        }

        function showCloneSessionModal() {
            document.getElementById('cloneSessionModal').classList.add('active');
        }

        function closeCloneSessionModal() {
            document.getElementById('cloneSessionModal').classList.remove('active');
        }

        function cloneSession() {
            const newName = document.getElementById('cloneSessionName').value.trim();
            const description = document.getElementById('cloneSessionDescription').value.trim();

            if (!newName) {
                alert('Please enter a name for the cloned session');
                return;
            }

            const sourceRef = database.ref('sessions/' + currentSession);
            const targetRef = database.ref('sessions/' + newName);

            targetRef.once('value', (snapshot) => {
                if (snapshot.exists()) {
                    alert('A session with this name already exists');
                    return;
                }

                sourceRef.once('value', (snapshot) => {
                    const sourceData = snapshot.val();
                    const clonedData = {
                        name: newName,
                        description: description,
                        created: firebase.database.ServerValue.TIMESTAMP,
                        archived: false,
                        teams: {},
                        actionHistory: {},
                        combatLog: {},
                        initiative: {}
                    };

                    if (sourceData.teams) {
                        Object.entries(sourceData.teams).forEach(([teamId, team]) => {
                            clonedData.teams[teamId] = { ...team };
                            if (team.characters) {
                                Object.entries(team.characters).forEach(([charId, char]) => {
                                    clonedData.teams[teamId].characters[charId] = {
                                        ...char,
                                        currentHealth: char.maxHealth,
                                        status: 'alive',
                                        statusEffects: [],
                                        consumables: char.consumables ? char.consumables.map(c => ({
                                            ...c,
                                            uses: c.maxUses
                                        })) : []
                                    };
                                });
                            }
                        });
                    }

                    targetRef.set(clonedData).then(() => {
                        closeCloneSessionModal();
                        alert(`Session cloned as "${newName}"`);
                        loadAllSessions();
                    });
                });
            });
        }

        function cloneSessionByName(sessionName) {
            document.getElementById('cloneSessionName').value = sessionName + '-copy';
            
            const sourceRef = database.ref('sessions/' + sessionName);
            sourceRef.once('value', (snapshot) => {
                const data = snapshot.val();
                document.getElementById('cloneSessionDescription').value = data.description || '';
                
                const originalSession = currentSession;
                currentSession = sessionName;
                
                showCloneSessionModal();
                
                const oldClone = window.cloneSession;
                window.cloneSession = function() {
                    oldClone();
                    currentSession = originalSession;
                    window.cloneSession = oldClone;
                };
            });
        }

        // Character Management
        function openAddTeamModal() {
            try {
                console.log('Opening Add Model modal...');
                
                // Ensure we're in a session
                if (!currentSession) {
                    alert('Please join a session first!');
                    return;
                }
                
                editingCharacter = null;
                document.getElementById('modalTitle').textContent = 'Add Model';
                document.getElementById('characterForm').reset();
                weaponFields = [];
                consumableFields = [];
                specialActionFields = [];
                renderWeaponFields();
                renderConsumableFields();
                renderSpecialActionFields();
                addWeaponField();
                addConsumableField();
                addSpecialActionField();
                
                // Reset preset selectors
                document.getElementById('presetFactionSelect').value = '';
                document.getElementById('presetModelGroup').style.display = 'none';
                document.getElementById('presetModelSelect').innerHTML = '<option value="">-- Select Model --</option>';
                
                // Set random color
                const randomColor = generateRandomColor();
                document.getElementById('charColor').value = randomColor;
                updateColorPreview();
                
                document.getElementById('characterModal').classList.add('active');
                console.log('Modal opened successfully!');
            } catch (error) {
                console.error('Error opening modal:', error);
                alert('Error opening modal: ' + error.message);
            }
        }
        
        function updateColorPreview() {
            const color = document.getElementById('charColor').value;
            document.getElementById('colorPreview').style.background = color;
        }

        function updateModelPresets() {
            const factionSelect = document.getElementById('presetFactionSelect');
            const modelSelect = document.getElementById('presetModelSelect');
            const modelGroup = document.getElementById('presetModelGroup');
            const selectedFaction = factionSelect.value;
            
            if (!selectedFaction) {
                modelGroup.style.display = 'none';
                return;
            }
            
            // Get models for selected faction
            const factionModels = gameData.models.filter(m => m.faction === selectedFaction);
            
            // Populate model dropdown
            modelSelect.innerHTML = '<option value="">-- Select Model --</option>' + 
                factionModels.map(model => 
                    `<option value="${model.name}">${model.name} (${model.points}pts - ${model.type})</option>`
                ).join('');
            
            modelGroup.style.display = 'block';
        }

        function fillFormFromPreset() {
            const factionName = document.getElementById('presetFactionSelect').value;
            const modelName = document.getElementById('presetModelSelect').value;
            
            if (!factionName || !modelName) return;
            
            const model = gameData.models.find(m => m.name === modelName && m.faction === factionName);
            if (!model) return;
            
            // Fill form fields
            document.getElementById('charName').value = model.name;
            document.getElementById('charRole').value = model.type;
            document.getElementById('charPortrait').value = model.portrait;
            document.getElementById('charSpeed').value = model.speed;
            document.getElementById('charShoot').value = model.shoot;
            document.getElementById('charFight').value = model.fight;
            document.getElementById('charNerve').value = model.nerve;
            document.getElementById('charHealth').value = model.health;
            
            // Get faction-specific weapons and add first one
            const factionWeapons = gameData.weapons.filter(w => w.faction === factionName);
            if (factionWeapons.length > 0 && weaponFields.length === 1 && !weaponFields[0].name) {
                // Replace the empty weapon field
                const weapon = factionWeapons[0];
                weaponFields[0] = {
                    name: weapon.name,
                    type: weapon.type,
                    attacks: weapon.attacks,
                    power: weapon.power,
                    damage: weapon.damage,
                    effects: weapon.effects || ''
                };
                renderWeaponFields();
            }
            
            // Auto-fill Jet Pack for all Arc Rangers
            if (factionName === 'Arc Rangers') {
                // Check if jet pack already exists
                const hasJetPack = consumableFields.some(c => c.name && c.name.toLowerCase().includes('jet pack'));
                if (!hasJetPack) {
                    // Add jet pack if empty field exists
                    const emptyIndex = consumableFields.findIndex(c => !c.name);
                    if (emptyIndex >= 0) {
                        consumableFields[emptyIndex] = {
                            name: 'Jet Pack',
                            effect: 'Mobility: Can fly over terrain and enemies',
                            amount: 3,
                            maxUses: 3,
                            targetType: 'Self'
                        };
                    } else {
                        // Add new field
                        consumableFields.push({
                            name: 'Jet Pack',
                            effect: 'Mobility: Can fly over terrain and enemies',
                            amount: 3,
                            maxUses: 3,
                            targetType: 'Self'
                        });
                    }
                    renderConsumableFields();
                }
            }
            
            // Scroll to top of form
            document.querySelector('.modal-content').scrollTop = 0;
        }

        function closeCharacterModal() {
            document.getElementById('characterModal').classList.remove('active');
            editingCharacter = null;
        }

        function addWeaponField(name = '', type = 'Ranged', attacks = '', power = '', damage = '') {
            weaponFields.push({ name, type, attacks, power, damage });
            renderWeaponFields();
        }

        function removeWeaponField(index) {
            weaponFields.splice(index, 1);
            renderWeaponFields();
        }

        function renderWeaponFields() {
            const container = document.getElementById('weaponsFormList');
            container.innerHTML = weaponFields.map((weapon, index) => `
                <div class="weapon-entry">
                    <select onchange="if(this.value) { const preset = presetWeapons.find(w => w.name === this.value); Object.assign(weaponFields[${index}], preset); renderWeaponFields(); }">
                        <option value="">-- Quick Select --</option>
                        ${presetWeapons.map(w => `<option value="${w.name}">${w.name} (${w.type}, A${w.attacks} P${w.power} D${w.damage})</option>`).join('')}
                    </select>
                    <input type="text" placeholder="Weapon name" value="${weapon.name}" onchange="weaponFields[${index}].name = this.value" style="min-width: 120px;" />
                    <select onchange="weaponFields[${index}].type = this.value">
                        <option value="Melee" ${weapon.type === 'Melee' ? 'selected' : ''}>Melee</option>
                        <option value="Ranged" ${weapon.type === 'Ranged' ? 'selected' : ''}>Ranged</option>
                    </select>
                    <input type="number" placeholder="Attacks" value="${weapon.attacks}" onchange="weaponFields[${index}].attacks = this.value" style="width: 80px;" />
                    <input type="number" placeholder="Power" value="${weapon.power}" onchange="weaponFields[${index}].power = this.value" style="width: 80px;" />
                    <input type="number" placeholder="Damage" value="${weapon.damage}" onchange="weaponFields[${index}].damage = this.value" style="width: 80px;" />
                    <button type="button" class="btn btn-danger" onclick="removeWeaponField(${index})">Remove</button>
                </div>
            `).join('');
        }

        function addConsumableField(name = '', effect = 'heal', amount = '', maxUses = '', targetType = 'self') {
            consumableFields.push({ name, effect, amount, maxUses, targetType });
            renderConsumableFields();
        }

        function removeConsumableField(index) {
            consumableFields.splice(index, 1);
            renderConsumableFields();
        }

        function renderConsumableFields() {
            const container = document.getElementById('consumablesFormList');
            container.innerHTML = consumableFields.map((consumable, index) => `
                <div class="consumable-entry">
                    <select onchange="if(this.value) { const preset = presetConsumables.find(c => c.name === this.value); Object.assign(consumableFields[${index}], preset); renderConsumableFields(); }" style="min-width: 150px;">
                        <option value="">-- Quick Select --</option>
                        ${presetConsumables.map(c => {
                            const effectIcon = c.effect === 'heal' ? 'heal' : c.effect === 'damage' ? 'damage' : 'Initiative';
                            return `<option value="${c.name}">${effectIcon} ${c.name} (${c.effect} ${c.amount})</option>`;
                        }).join('')}
                    </select>
                    <input type="text" placeholder="Item name" value="${consumable.name}" onchange="consumableFields[${index}].name = this.value" style="min-width: 120px;" />
                    <select onchange="consumableFields[${index}].effect = this.value">
                        <option value="heal" ${consumable.effect === 'heal' ? 'selected' : ''}>Heal</option>
                        <option value="buff" ${consumable.effect === 'buff' ? 'selected' : ''}>Buff</option>
                        <option value="damage" ${consumable.effect === 'damage' ? 'selected' : ''}>Damage</option>
                    </select>
                    <input type="number" placeholder="Amount" value="${consumable.amount}" onchange="consumableFields[${index}].amount = this.value" style="width: 80px;" />
                    <input type="number" placeholder="Uses" value="${consumable.maxUses}" onchange="consumableFields[${index}].maxUses = this.value" style="width: 70px;" />
                    <select onchange="consumableFields[${index}].targetType = this.value">
                        <option value="self" ${consumable.targetType === 'self' ? 'selected' : ''}>Self</option>
                        <option value="other" ${consumable.targetType === 'other' ? 'selected' : ''}>Other</option>
                    </select>
                    <button type="button" class="btn btn-danger" onclick="removeConsumableField(${index})">Remove</button>
                </div>
            `).join('');
        }

        // Special Action Field Management
        function addSpecialActionField(name = '', description = '', effects = '', maxUses = 1) {
            specialActionFields.push({ name, description, effects, maxUses, uses: maxUses });
            renderSpecialActionFields();
        }

        function removeSpecialActionField(index) {
            specialActionFields.splice(index, 1);
            renderSpecialActionFields();
        }

        function renderSpecialActionFields() {
            const container = document.getElementById('specialActionsFormList');
            if (!container) return; // In case the element doesn't exist yet
            
            // Get faction-specific special actions
            let availableActions = [];
            if (currentSession && currentPlayer) {
                const teamRef = database.ref(`sessions/${currentSession}/teams/${currentPlayer.replace(/\s/g, '_')}`);
                teamRef.once('value', (snapshot) => {
                    const team = snapshot.val();
                    if (team && team.faction) {
                        availableActions = gameData.specialActions.filter(a => a.faction === team.faction);
                    }
                });
            }
            
            const presetDropdown = availableActions.length > 0 ? `
                <div style="margin-bottom: 15px; padding: 10px; background: rgba(255, 149, 0, 0.1); border-radius: 5px;">
                    <label style="color: #FF9500; margin-bottom: 5px; display: block;">Add Preset Action:</label>
                    <select id="presetActionSelect" style="width: 100%; padding: 8px; background: rgba(0,0,0,0.5); border: 1px solid #FF9500; color: white; border-radius: 5px;">
                        <option value="">-- Select Preset --</option>
                        ${availableActions.map(action => `
                            <option value="${action.name}">${action.name} (${action.maxUses} uses)</option>
                        `).join('')}
                    </select>
                    <button type="button" class="btn btn-success" onclick="addPresetSpecialAction()" style="margin-top: 10px; width: 100%;">Add Selected Preset</button>
                </div>
            ` : '';
            
            container.innerHTML = presetDropdown + specialActionFields.map((action, index) => `
                <div class="consumable-entry" style="flex-wrap: wrap;">
                    <input type="text" placeholder="Action name" value="${action.name}" onchange="specialActionFields[${index}].name = this.value" style="min-width: 150px;" />
                    <input type="text" placeholder="Description" value="${action.description}" onchange="specialActionFields[${index}].description = this.value" style="min-width: 200px; flex: 1;" />
                    <input type="text" placeholder="Effects (e.g., Dangerous)" value="${action.effects}" onchange="specialActionFields[${index}].effects = this.value" style="min-width: 120px;" />
                    <input type="number" placeholder="Max Uses" value="${action.maxUses}" onchange="specialActionFields[${index}].maxUses = this.value; specialActionFields[${index}].uses = this.value;" style="width: 80px;" min="1" />
                    <button type="button" class="btn btn-danger" onclick="removeSpecialActionField(${index})">Remove</button>
                </div>
            `).join('');
        }
        
        function addPresetSpecialAction() {
            const select = document.getElementById('presetActionSelect');
            const actionName = select.value;
            if (!actionName) {
                alert('Please select a preset action');
                return;
            }
            
            const preset = gameData.specialActions.find(a => a.name === actionName);
            if (preset) {
                addSpecialActionField(preset.name, preset.description, preset.effects, preset.maxUses);
                select.value = ''; // Reset dropdown
            }
        }

        function openEditModal(teamId, charId, character) {
            editingCharacter = { teamId, charId };
            document.getElementById('modalTitle').textContent = 'Edit Character';
            
            // If character not provided, fetch it
            if (!character) {
                database.ref(`sessions/${currentSession}/teams/${teamId}/characters/${charId}`).once('value', (snapshot) => {
                    const char = snapshot.val();
                    if (char) {
                        populateEditForm(char);
                    }
                });
            } else {
                populateEditForm(character);
            }
            
            document.getElementById('characterModal').classList.add('active');
        }
        
        function populateEditForm(character) {
            document.getElementById('charName').value = character.name || '';
            document.getElementById('charRole').value = character.role || '';
            document.getElementById('charPortrait').value = character.portrait || '';
            document.getElementById('charSpeed').value = character.speed || '';
            document.getElementById('charShoot').value = character.shoot || '';
            document.getElementById('charFight').value = character.fight || '';
            document.getElementById('charNerve').value = character.nerve || '';
            document.getElementById('charHealth').value = character.maxHealth || 15;
            document.getElementById('charColor').value = character.color || generateRandomColor();
            updateColorPreview();
            document.getElementById('charInventory').value = character.inventory ? character.inventory.join(', ') : '';
            document.getElementById('charNotes').value = character.notes || '';

            weaponFields = character.weapons ? character.weapons.map(w => ({...w})) : [];
            renderWeaponFields();
            if (weaponFields.length === 0) addWeaponField();

            consumableFields = character.consumables ? character.consumables.map(c => ({
                name: c.name,
                effect: c.effect,
                amount: c.amount,
                maxUses: c.maxUses,
                targetType: c.targetType
            })) : [];
            renderConsumableFields();
            if (consumableFields.length === 0) addConsumableField();
            
            // Load special actions if they exist
            specialActionFields = character.specialActions ? character.specialActions.map(a => ({...a})) : [];
            renderSpecialActionFields();
            if (specialActionFields.length === 0) addSpecialActionField();
        }

        document.getElementById('characterForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const character = {
                name: document.getElementById('charName').value.trim(),
                role: document.getElementById('charRole').value.trim(),
                portrait: document.getElementById('charPortrait').value.trim(),
                speed: document.getElementById('charSpeed').value.trim(),
                shoot: document.getElementById('charShoot').value.trim(),
                fight: document.getElementById('charFight').value.trim(),
                nerve: document.getElementById('charNerve').value.trim(),
                maxHealth: parseInt(document.getElementById('charHealth').value),
                currentHealth: parseInt(document.getElementById('charHealth').value),
                color: document.getElementById('charColor').value,
                portraitColor: document.getElementById('charColor').value, // Use same color for portrait background
                weapons: weaponFields.filter(w => w.name && w.attacks && w.power && w.damage),
                consumables: consumableFields.filter(c => c.name && c.amount && c.maxUses).map(c => ({
                    name: c.name,
                    effect: c.effect,
                    amount: parseInt(c.amount),
                    maxUses: parseInt(c.maxUses),
                    uses: parseInt(c.maxUses),
                    targetType: c.targetType
                })),
                inventory: document.getElementById('charInventory').value.split(',').map(i => i.trim()).filter(i => i),
                notes: document.getElementById('charNotes').value.trim(),
                status: 'alive',
                statusEffects: [],
                turnTaken: false,
                specialActions: specialActionFields.filter(a => a.name).map(a => ({
                    name: a.name,
                    description: a.description || '',
                    effects: a.effects || '',
                    maxUses: parseInt(a.maxUses) || 1,
                    uses: parseInt(a.maxUses) || 1
                })),
                owner: currentPlayer
            };
            
            // Auto-add Jump Boost for Arc Rangers if not already present
            const checkTeamRef = database.ref(`sessions/${currentSession}/teams/${currentPlayer.replace(/\s/g, '_')}`);
            checkTeamRef.once('value', (teamSnapshot) => {
                const team = teamSnapshot.val();
                if (team && team.faction === 'Arc Rangers') {
                    const hasJumpBoost = character.specialActions.some(a => a.name === 'Jump Boost');
                    if (!hasJumpBoost) {
                        character.specialActions.unshift({
                            name: 'Jump Boost',
                            description: 'Uses jet pack to boost 6 inches. Ignores terrain.',
                            effects: 'Dangerous terrain test required',
                            maxUses: 1,
                            uses: 1
                        });
                    }
                }
                
                // Now save the character
                if (editingCharacter) {
                const charRef = database.ref(`sessions/${currentSession}/teams/${editingCharacter.teamId}/characters/${editingCharacter.charId}`);
                charRef.once('value', (snapshot) => {
                    const existing = snapshot.val();
                    character.currentHealth = existing.currentHealth;
                    character.status = existing.status;
                    character.statusEffects = existing.statusEffects || [];
                    if (existing.consumables && character.consumables) {
                        character.consumables = character.consumables.map((newCons, idx) => {
                            const existingCons = existing.consumables.find(ec => ec.name === newCons.name);
                            if (existingCons) {
                                return { ...newCons, uses: existingCons.uses };
                            }
                            return newCons;
                        });
                    }
                    charRef.update(character);
                });
            } else {
                const teamId = currentPlayer.replace(/\s/g, '_');
                const charId = 'char_' + Date.now();
                const teamRef = database.ref(`sessions/${currentSession}/teams/${teamId}`);
                
                teamRef.once('value', (snapshot) => {
                    if (snapshot.exists()) {
                        teamRef.child('characters/' + charId).set(character);
                    } else {
                        teamRef.set({
                            owner: currentPlayer,
                            characters: {
                                [charId]: character
                            }
                        });
                    }
                });
            }
            
            closeCharacterModal();
            }); // End teamSnapshot callback
        });

        function updateHealth(teamId, charId, change) {
            const charRef = database.ref(`sessions/${currentSession}/teams/${teamId}/characters/${charId}`);
            charRef.once('value', (snapshot) => {
                const char = snapshot.val();
                const newHealth = Math.max(0, Math.min(char.maxHealth, char.currentHealth + change));
                charRef.update({ 
                    currentHealth: newHealth,
                    status: newHealth > 0 ? 'alive' : 'dead'
                });
                
                // Add flash animation
                const cardElement = document.getElementById(`model-card-${teamId}-${charId}`);
                if (cardElement) {
                    const flashClass = change < 0 ? 'damage-flash' : 'heal-flash';
                    cardElement.classList.add(flashClass);
                    setTimeout(() => {
                        cardElement.classList.remove(flashClass);
                    }, 2000);
                }
                
                const action = change > 0 ? 'healed' : 'damaged';
                logAction(`${char.name} ${action} for ${Math.abs(change)} HP`, {
                    type: 'healthChange',
                    teamId: teamId,
                    charId: charId,
                    change: change
                });
                
                logToCombat(`${change > 0 ? 'heal' : ''} ${char.name} ${action} ${Math.abs(change)} HP (${newHealth}/${char.maxHealth})`);
            });
        }

        function useConsumable(teamId, charId, consumableIndex, targetTeamId = null, targetCharId = null) {
            const charRef = database.ref(`sessions/${currentSession}/teams/${teamId}/characters/${charId}`);
            charRef.once('value', (snapshot) => {
                const char = snapshot.val();
                const consumable = char.consumables[consumableIndex];
                
                if (consumable.uses <= 0) {
                    alert('No uses remaining!');
                    return;
                }
                
                let actualTargetTeamId = targetTeamId || teamId;
                let actualTargetCharId = targetCharId || charId;
                
                if (consumable.targetType === 'other' && !targetTeamId) {
                    alert('Please select a target');
                    return;
                }
                
                const targetRef = database.ref(`sessions/${currentSession}/teams/${actualTargetTeamId}/characters/${actualTargetCharId}`);
                targetRef.once('value', (targetSnapshot) => {
                    const targetChar = targetSnapshot.val();
                    let healthChange = 0;
                    
                    if (consumable.effect === 'heal') {
                        healthChange = consumable.amount;
                    } else if (consumable.effect === 'damage') {
                        healthChange = -consumable.amount;
                    }
                    
                    const newHealth = Math.max(0, Math.min(targetChar.maxHealth, targetChar.currentHealth + healthChange));
                    targetRef.update({
                        currentHealth: newHealth,
                        status: newHealth > 0 ? 'alive' : 'dead'
                    });
                    
                    const updatedConsumables = [...char.consumables];
                    updatedConsumables[consumableIndex].uses -= 1;
                    charRef.update({ consumables: updatedConsumables });
                    
                    const effectDesc = consumable.effect === 'heal' ? 'healed' : 'damaged';
                    logAction(`${char.name} used ${consumable.name} and ${effectDesc} ${targetChar.name} for ${Math.abs(healthChange)} HP`, {
                        type: 'consumableUse',
                        teamId: teamId,
                        charId: charId,
                        consumableIndex: consumableIndex,
                        targetTeamId: actualTargetTeamId,
                        targetCharId: actualTargetCharId,
                        healthChange: healthChange
                    });
                    
                    logToCombat(` ${char.name} used ${consumable.name} on ${targetChar.name} (${effectDesc} ${Math.abs(healthChange)} HP)`);
                });
            });
        }

        function attackCharacter(attackerTeamId, attackerCharId) {
            const targetSelect = document.getElementById(`target-${attackerTeamId}-${attackerCharId}`);
            const damageInput = document.getElementById(`damage-${attackerTeamId}-${attackerCharId}`);
            
            const targetValue = targetSelect.value;
            const damage = parseInt(damageInput.value) || 0;

            if (!targetValue || damage <= 0) {
                alert('Please select a target and enter damage amount');
                return;
            }

            const [targetTeamId, targetCharId] = targetValue.split(':');
            
            const attackerRef = database.ref(`sessions/${currentSession}/teams/${attackerTeamId}/characters/${attackerCharId}`);
            const targetRef = database.ref(`sessions/${currentSession}/teams/${targetTeamId}/characters/${targetCharId}`);
            
            Promise.all([
                attackerRef.once('value'),
                targetRef.once('value')
            ]).then(([attackerSnapshot, targetSnapshot]) => {
                const attacker = attackerSnapshot.val();
                const target = targetSnapshot.val();
                
                updateHealth(targetTeamId, targetCharId, -damage);
                
                logAction(`${attacker.name} attacked ${target.name} for ${damage} damage`, {
                    type: 'healthChange',
                    teamId: targetTeamId,
                    charId: targetCharId,
                    change: -damage
                });
                
                logToCombat(`Attack ${attacker.name} → ${target.name}: ${damage} damage`);
            });
            
            targetSelect.value = '';
            damageInput.value = '';
        }

        function toggleTurnStatus(teamId, charId) {
            const charRef = database.ref(`sessions/${currentSession}/teams/${teamId}/characters/${charId}`);
            charRef.once('value', (snapshot) => {
                const char = snapshot.val();
                charRef.update({ turnTaken: !char.turnTaken });
                logToCombat(`${char.name} ${!char.turnTaken ? 'took their turn' : 'turn reset'}`);
            });
        }

        function resetTeamTurns(teamId) {
            const teamRef = database.ref(`sessions/${currentSession}/teams/${teamId}/characters`);
            teamRef.once('value', (snapshot) => {
                const characters = snapshot.val() || {};
                Object.keys(characters).forEach(charId => {
                    teamRef.child(charId).update({ turnTaken: false });
                });
                logToCombat(`Reset All turns reset for team`);
            });
        }

        function editPortrait(teamId, charId) {
            const charRef = database.ref(`sessions/${currentSession}/teams/${teamId}/characters/${charId}`);
            charRef.once('value', (snapshot) => {
                const char = snapshot.val();
                const newUrl = prompt('Enter new portrait URL:', char.portrait || '');
                if (newUrl !== null) {
                    charRef.update({ portrait: newUrl });
                }
            });
        }

        function toggleStatus(teamId, charId) {
            const charRef = database.ref(`sessions/${currentSession}/teams/${teamId}/characters/${charId}`);
            charRef.once('value', (snapshot) => {
                const char = snapshot.val();
                const newStatus = char.status === 'alive' ? 'dead' : 'alive';
                charRef.update({ status: newStatus });
                
                logToCombat(`${newStatus === 'dead' ? '' : 'heal'} ${char.name} is now ${newStatus}`);
            });
        }

        function deleteCharacter(teamId, charId) {
            if (confirm('Are you sure you want to delete this character?')) {
                database.ref(`sessions/${currentSession}/teams/${teamId}/characters/${charId}`).remove();
            }
        }

        function deleteTeam(teamId) {
            if (confirm('Are you sure you want to delete this entire team?')) {
                database.ref(`sessions/${currentSession}/teams/${teamId}`).remove();
            }
        }

        function toggleCharacterExpand(teamId, charId) {
            const detailsEl = document.getElementById(`details-${teamId}-${charId}`);
            const toggleEl = document.getElementById(`toggle-${teamId}-${charId}`);
            
            if (detailsEl.classList.contains('hidden')) {
                detailsEl.classList.remove('hidden');
                toggleEl.textContent = ' Show Less';
            } else {
                detailsEl.classList.add('hidden');
                toggleEl.textContent = ' Show More';
            }
        }

        function renderTeams(teams) {
            const container = document.getElementById('teamsContainer');
            const summaryContainer = document.getElementById('teamsSummary');
            const summaryContent = document.getElementById('teamsSummaryContent');
            
            if (!teams || Object.keys(teams).length === 0) {
                container.innerHTML = '<div class="empty-state"><h3>No teams yet</h3><p>Click "Add Model" to create your first character</p></div>';
                summaryContainer.style.display = 'none';
                return;
            }
            
            // Show and render team summary
            summaryContainer.style.display = 'block';
            summaryContent.innerHTML = Object.entries(teams).map(([teamId, team]) => {
                const characters = team.characters ? Object.values(team.characters).filter(c => c.status === 'alive') : [];
                const healthStats = {
                    healthy: 0,  // >70%
                    damaged: 0,  // 40-70%
                    critical: 0, // 10-40%
                    dead: 0      // 0-10% or dead
                };
                
                characters.forEach(char => {
                    const healthPercent = (char.currentHealth / char.maxHealth) * 100;
                    if (healthPercent > 70) healthStats.healthy++;
                    else if (healthPercent > 40) healthStats.damaged++;
                    else if (healthPercent > 10) healthStats.critical++;
                    else healthStats.dead++;
                });
                
                const totalModels = characters.length;
                
                return `
                    <div style="background: rgba(0, 0, 0, 0.3); padding: 6px 10px; border-radius: 6px; display: flex; justify-content: space-between; align-items: center; border-left: 3px solid ${team.faction ? (gameData.factions.find(f => f.name === team.faction)?.primaryColor || '#FF9500') : '#FF9500'};">
                        <div>
                            <div style="font-weight: bold; color: white; font-size: 0.95em;">${team.owner}'s Team</div>
                            <div style="color: #9CAF88; font-size: 0.8em;">${team.faction || 'Choose Faction'} • ${totalModels} model${totalModels !== 1 ? 's' : ''}</div>
                        </div>
                        <div style="display: flex; gap: 4px; align-items: center;">
                            ${Array(healthStats.healthy).fill('<span style="color: #4CAF50; font-size: 16px;">●</span>').join('')}
                            ${Array(healthStats.damaged).fill('<span style="color: #FFA500; font-size: 16px;">●</span>').join('')}
                            ${Array(healthStats.critical).fill('<span style="color: #F44336; font-size: 16px;">●</span>').join('')}
                            ${Array(healthStats.dead).fill('<span style="color: #666; font-size: 16px;">●</span>').join('')}
                            ${totalModels === 0 ? '<span style="color: #666; font-size: 0.85em;">No models</span>' : ''}
                        </div>
                    </div>
                `;
            }).join('');

            const allCharacters = [];
            Object.entries(teams).forEach(([teamId, team]) => {
                if (team.characters) {
                    Object.entries(team.characters).forEach(([charId, char]) => {
                        if (char.status === 'alive') {
                            allCharacters.push({
                                teamId,
                                charId,
                                name: char.name,
                                owner: team.owner
                            });
                        }
                    });
                }
            });

            container.innerHTML = '';
            
            // Add view toggle buttons at top (once)
            const controlsDiv = document.createElement('div');
            controlsDiv.style.cssText = 'background: rgba(255, 149, 0, 0.1); padding: 10px; border-radius: 8px; margin-bottom: 15px; display: flex; gap: 10px; align-items: center; justify-content: space-between; border: 1px solid #FF9500; flex-wrap: wrap;';
            controlsDiv.innerHTML = `
                <div style="display: flex; gap: 10px; align-items: center;">
                    <span style="color: #FF9500; font-weight: bold; margin-right: 10px;">View Mode:</span>
                    <button class="btn ${currentView === 'expanded' ? 'btn-primary' : 'btn-secondary'}" onclick="currentView='expanded'; renderTeams(${JSON.stringify(teams).replace(/"/g, '&quot;')})">Expanded</button>
                    <button class="btn ${currentView === 'compact' ? 'btn-primary' : 'btn-secondary'}" onclick="currentView='compact'; renderTeams(${JSON.stringify(teams).replace(/"/g, '&quot;')})">Compact</button>
                    <button class="btn ${currentView === 'tiny' ? 'btn-primary' : 'btn-secondary'}" onclick="currentView='tiny'; renderTeams(${JSON.stringify(teams).replace(/"/g, '&quot;')})">Tiny</button>
                </div>
            `;
            container.appendChild(controlsDiv);
            
            // Add "My Team" section at top
            const myTeamSection = document.createElement('div');
            myTeamSection.style.cssText = 'background: rgba(156, 175, 136, 0.1); padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 2px solid #9CAF88;';
            const playerName = currentPlayer || localStorage.getItem('lastPlayerName') || 'Your';
            const myTeamId = Object.keys(teams).find(id => teams[id].owner === currentPlayer);
            const myTeam = myTeamId ? teams[myTeamId] : null;
            
            myTeamSection.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                    <div>
                        <h3 style="color: #9CAF88; margin: 0 0 5px 0;">My Team</h3>
                        ${myTeam ? `
                            <div style="color: #ccc; font-size: 0.95em;">
                                ${myTeam.faction || 'No Faction'} • ${myTeam.characters ? Object.keys(myTeam.characters).length : 0} models
                            </div>
                        ` : `
                            <div style="color: #888; font-size: 0.9em;">No team loaded</div>
                        `}
                    </div>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn btn-success" onclick="openAddTeamModal()" style="font-size: 1em; padding: 10px 15px;">+ Add Model</button>
                        <button class="btn btn-primary" onclick="showLoadTeamModal()" style="font-size: 1em; padding: 10px 15px;">Load Saved Team</button>
                        <button class="btn btn-secondary" onclick="returnToLanding(); showTeamBuilder();" style="font-size: 1em; padding: 10px 15px;">Build New Team</button>
                    </div>
                </div>
            `;
            container.appendChild(myTeamSection);

            // Sort teams: current player's team first, then others
            const sortedTeams = Object.entries(teams).sort(([idA, teamA], [idB, teamB]) => {
                if (teamA.owner === currentPlayer) return -1;
                if (teamB.owner === currentPlayer) return 1;
                return 0;
            });

            sortedTeams.forEach(([teamId, team]) => {
                const teamDiv = document.createElement('div');
                teamDiv.className = 'team';

                let teamHTML = `
                    <div class="team-header">
                        <div>
                            <h2>${team.owner}'s Team</h2>
                            ${team.faction ? `<div style="color: #9CAF88; font-size: 1.1em; margin-top: 5px;">Faction: ${team.faction}</div>` : ''}
                        </div>
                        <div class="team-controls">
                            <button class="btn btn-warning" onclick="resetTeamTurns('${teamId}')">Reset All Turns</button>
                            ${team.owner === currentPlayer ? `
                                <button class="btn btn-success" onclick="openAddTeamModal()">+ Add Model</button>
                                <button class="btn btn-danger" onclick="deleteTeam('${teamId}')">Delete Team</button>
                            ` : ''}
                        </div>
                    </div>
                    <div class="characters-grid ${currentView === 'tiny' ? 'tiny' : currentView === 'compact' ? 'compact' : ''}">
                `;

                if (team.characters) {
                    Object.entries(team.characters).forEach(([charId, char]) => {
                        const healthPercent = (char.currentHealth / char.maxHealth) * 100;
                        const healthColor = healthPercent > 50 ? '#48bb78' : healthPercent > 25 ? '#f6ad55' : '#f56565';

                        const targetOptions = allCharacters
                            .filter(target => !(target.teamId === teamId && target.charId === charId))
                            .map(target => `<option value="${target.teamId}:${target.charId}">${target.owner} - ${target.name}</option>`)
                            .join('');

// ULTRA-COMPACT VIEW
if (currentView === 'tiny') {
    teamHTML += `
        <div class="model-card tiny ${char.status === 'dead' ? 'dead' : ''}" id="model-card-${teamId}-${charId}">
            ${char.portrait ? `
                <img src="${char.portrait}" 
                     alt="${char.name}" 
                     class="model-portrait-new"
                     style="border: 3px solid ${char.color || '#FF9500'};"
                     onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                <div class="model-portrait-new" style="display: none; background: ${char.portraitColor || char.color || '#FF9500'}; border: 3px solid ${char.color || '#FF9500'}; align-items: center; justify-content: center; font-size: 20px; font-weight: bold; color: white;">${char.name[0]}</div>
            ` : `
                <div class="model-portrait-new" style="background: ${char.portraitColor || char.color || '#FF9500'}; border: 3px solid ${char.color || '#FF9500'}; display: flex; align-items: center; justify-content: center; font-size: 20px; font-weight: bold; color: white;">${char.name[0]}</div>
            `}
            <div style="display: flex; justify-content: space-between; align-items: center; margin: 3px 0; gap: 3px;">
                <span class="status-indicator status-${char.status}" style="font-size: 0.6em; padding: 2px 4px; flex: 1; text-align: center;">${char.status}</span>
                <button class="btn ${char.turnTaken ? 'btn-secondary' : 'btn-primary'}" style="padding: 2px 6px; font-size: 0.6em; flex: 1;" onclick="toggleTurnStatus('${teamId}', '${charId}')">
                    ${char.turnTaken ? 'Done' : 'Ready'}
                </button>
            </div>
            <div class="model-name-new" title="${char.name}">${char.name}</div>
            <div class="ultra-hp">${char.currentHealth}/${char.maxHealth}</div>
        </div>
    `;
} else {
// NORMAL/COMPACT VIEW
teamHTML += `
    <div class="model-card ${char.status === 'dead' ? 'dead' : ''} ${currentView === 'compact' ? 'compact' : ''}" id="model-card-${teamId}-${charId}">
        
        <!-- Status and Ready/Done at Top -->
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; gap: 10px;">
            <span class="status-indicator status-${char.status}" style="flex: 0 0 auto;">${char.status}</span>
            <button class="btn ${char.turnTaken ? 'btn-secondary' : 'btn-primary'}" style="flex: 0 0 auto; padding: 4px 12px; font-size: 0.85em;" onclick="toggleTurnStatus('${teamId}', '${charId}')">
                ${char.turnTaken ? 'Done' : 'Ready'}
            </button>
        </div>
        
        <!-- SECTION 1: Header - Portrait, Name, Stats, Effects -->
        <div class="model-section-1">
            <div class="model-header-top">
                ${char.portrait ? `
                    <img src="${char.portrait}" 
                         alt="${char.name}" 
                         class="model-portrait-new"
                         style="border: 4px solid ${char.color || '#FF9500'};"
                         onclick="editPortrait('${teamId}', '${charId}')"
                         onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
                         title="Click to change portrait">
                    <div class="model-portrait-new" style="display: none; background: ${char.portraitColor || char.color || '#FF9500'}; border: 4px solid ${char.color || '#FF9500'}; align-items: center; justify-content: center; font-size: 48px; font-weight: bold; color: white; cursor: pointer;" onclick="editPortrait('${teamId}', '${charId}')" title="Click to change portrait">${char.name[0]}</div>
                ` : `
                    <div class="model-portrait-new" style="background: ${char.portraitColor || char.color || '#FF9500'}; border: 4px solid ${char.color || '#FF9500'}; display: flex; align-items: center; justify-content: center; font-size: 48px; font-weight: bold; color: white; cursor: pointer;" onclick="editPortrait('${teamId}', '${charId}')" title="Click to change color">${char.name[0]}</div>
                `}
                <div class="model-header-info">
                    <div class="model-name-row">
                        <h3 class="model-name-new">${char.name}</h3>
                    </div>
                    <div class="model-role">${char.role || 'Operative'}</div>
                    
                    <!-- Health Controls -->
                    <div style="display: flex; align-items: center; gap: 5px; margin-top: 8px;">
                        <button class="health-btn btn-danger" style="width: 30px; height: 30px; font-size: 14px;" onclick="updateHealth('${teamId}', '${charId}', -1)">-</button>
                        <div style="flex: 1; text-align: center; font-weight: bold; color: ${healthColor}; font-size: 1.1em;">
                            ${char.currentHealth}/${char.maxHealth} HP
                        </div>
                        <button class="health-btn btn-success" style="width: 30px; height: 30px; font-size: 14px;" onclick="updateHealth('${teamId}', '${charId}', 1)">+</button>
                    </div>
                </div>
            </div>
            
            <!-- Stats Grid -->
            <div class="model-stats-grid">
                ${char.speed ? `
                    <div class="model-stat-box">
                        <div class="model-stat-label">Speed</div>
                        <div class="model-stat-value">${char.speed}</div>
                    </div>
                ` : ''}
                ${char.shoot ? `
                    <div class="model-stat-box">
                        <div class="model-stat-label">Shoot</div>
                        <div class="model-stat-value">${char.shoot}</div>
                    </div>
                ` : ''}
                ${char.fight ? `
                    <div class="model-stat-box">
                        <div class="model-stat-label">Fight</div>
                        <div class="model-stat-value">${char.fight}</div>
                    </div>
                ` : ''}
                ${char.nerve ? `
                    <div class="model-stat-box">
                        <div class="model-stat-label">Nerve</div>
                        <div class="model-stat-value">${char.nerve}</div>
                    </div>
                ` : ''}
                <div class="model-stat-box">
                    <div class="model-stat-label">Health</div>
                    <div class="model-stat-value">${char.maxHealth}</div>
                </div>
            </div>
            
            <!-- Effects Field -->
            <div class="model-effects-field">
                <div class="model-effects-label">Effects:</div>
                <div class="model-effects-text">
                    ${char.statusEffects && char.statusEffects.length > 0 ? 
                        char.statusEffects.map(e => `${e.name} (${e.duration})`).join(', ') : 
                        'none'}
                </div>
            </div>
        </div>
        
        <!-- SECTION 2: Special Actions -->
        <div class="model-section-2">
            <div class="section-title">Special Actions</div>
            ${char.specialActions && char.specialActions.length > 0 ? char.specialActions.map((action, idx) => `
                <div class="special-action-item">
                    <div class="special-action-header">
                        <span class="special-action-name">${action.name}</span>
                        <span class="special-action-uses">${action.uses}/${action.maxUses} uses</span>
                    </div>
                    <div class="special-action-desc">${action.description}</div>
                    ${action.effects ? `<div class="special-action-effects">Effects: ${action.effects}</div>` : ''}
                </div>
            `).join('') : '<div style="color: #666; text-align: center; padding: 10px;">No special actions</div>'}
        </div>
        
        <!-- SECTION 3: Equipment -->
        <div class="model-section-3">
            <div class="section-title">Equipment</div>
            <div class="equipment-grid">
                <!-- Weapon Slot 1 -->
                <div class="equipment-slot ${!char.weapons || !char.weapons[0] ? 'empty' : ''}">
                    <div class="equipment-label">Weapon 1</div>
                    ${char.weapons && char.weapons[0] ? `
                        <div class="equipment-name">${char.weapons[0].name}</div>
                        <div class="equipment-stats">${char.weapons[0].type} | A${char.weapons[0].attacks} P${char.weapons[0].power} D${char.weapons[0].damage}</div>
                        ${char.weapons[0].effects ? `<div class="equipment-effects">${char.weapons[0].effects}</div>` : ''}
                    ` : '<div style="color: #666;">Empty</div>'}
                </div>
                
                <!-- Weapon Slot 2 -->
                <div class="equipment-slot ${!char.weapons || !char.weapons[1] ? 'empty' : ''}">
                    <div class="equipment-label">Weapon 2</div>
                    ${char.weapons && char.weapons[1] ? `
                        <div class="equipment-name">${char.weapons[1].name}</div>
                        <div class="equipment-stats">${char.weapons[1].type} | A${char.weapons[1].attacks} P${char.weapons[1].power} D${char.weapons[1].damage}</div>
                        ${char.weapons[1].effects ? `<div class="equipment-effects">${char.weapons[1].effects}</div>` : ''}
                    ` : '<div style="color: #666;">Empty</div>'}
                </div>
                
                <!-- Inventory Slot 1 -->
                <div class="equipment-slot ${!char.inventory || !char.inventory[0] ? 'empty' : ''}">
                    <div class="equipment-label">Inventory 1</div>
                    ${char.inventory && char.inventory[0] ? `
                        <div class="equipment-name">${char.inventory[0]}</div>
                    ` : '<div style="color: #666;">Empty</div>'}
                </div>
                
                <!-- Inventory Slot 2 -->
                <div class="equipment-slot ${!char.inventory || !char.inventory[1] ? 'empty' : ''}">
                    <div class="equipment-label">Inventory 2</div>
                    ${char.inventory && char.inventory[1] ? `
                        <div class="equipment-name">${char.inventory[1]}</div>
                    ` : '<div style="color: #666;">Empty</div>'}
                </div>
            </div>
            
            <!-- Notes Display -->
            ${char.notes ? `
                <div style="margin-top: 15px; padding: 10px; background: rgba(255, 255, 255, 0.05); border-radius: 5px; border-left: 3px solid #9CAF88;">
                    <div style="color: #9CAF88; font-weight: bold; margin-bottom: 5px;">Notes:</div>
                    <div style="color: #ccc; font-size: 0.9em; white-space: pre-wrap;">${char.notes}</div>
                </div>
            ` : ''}
            
            ${team.owner === currentPlayer && currentView === 'expanded' ? `
                <div style="margin-top: 15px; display: flex; gap: 5px; flex-wrap: wrap;">
                    <button class="btn btn-secondary" style="flex: 1; min-width: 120px; padding: 8px; font-size: 0.85em;" onclick="openEditModal('${teamId}', '${charId}')">Edit</button>
                    <button class="btn btn-danger" style="flex: 1; min-width: 120px; padding: 8px; font-size: 0.85em;" onclick="deleteCharacter('${teamId}', '${charId}')">Delete</button>
                </div>
            ` : ''}
        </div>
    </div>
`;
} // End tiny else

                    });
                }

                teamHTML += '</div></div>';
                teamDiv.innerHTML = teamHTML;
                container.appendChild(teamDiv);
            });
        }

        function useConsumableOnTarget(teamId, charId, consumableIndex) {
            const targetSelect = document.getElementById(`consumable-target-${teamId}-${charId}-${consumableIndex}`);
            const targetValue = targetSelect.value;
            
            if (!targetValue) {
                alert('Please select a target');
                return;
            }
            
            const [targetTeamId, targetCharId] = targetValue.split(':');
            useConsumable(teamId, charId, consumableIndex, targetTeamId, targetCharId);
        }

        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', function(e) {
                if (e.target === this) {
                    this.classList.remove('active');
                }
            });
        });

        // Load templates on page load
        loadTemplates();

        // ==================== TURN TIMER FUNCTIONS ====================
        let timerInterval = null;
        let timerSecondsLeft = 0;

        function startTimer() {
            const minutes = parseInt(document.getElementById('timerMinutes').value) || 0;
            const seconds = parseInt(document.getElementById('timerSeconds').value) || 0;
            
            if (!currentSession) return;
            
            const totalSeconds = (minutes * 60) + seconds;
            if (totalSeconds <= 0) {
                alert('Please enter a valid time');
                return;
            }
            
            database.ref(`sessions/${currentSession}/timer`).set({
                running: true,
                secondsLeft: totalSeconds,
                totalSeconds: totalSeconds,
                startedAt: firebase.database.ServerValue.TIMESTAMP
            });
        }

        function pauseTimer() {
            if (!currentSession) return;
            database.ref(`sessions/${currentSession}/timer/running`).set(false);
        }

        function resetTimer() {
            if (!currentSession) return;
            const minutes = parseInt(document.getElementById('timerMinutes').value) || 0;
            const seconds = parseInt(document.getElementById('timerSeconds').value) || 0;
            const totalSeconds = (minutes * 60) + seconds;
            
            database.ref(`sessions/${currentSession}/timer`).set({
                running: false,
                secondsLeft: totalSeconds,
                totalSeconds: totalSeconds,
                startedAt: null
            });
        }

        function updateTimerDisplay(secondsLeft) {
            const minutes = Math.floor(secondsLeft / 60);
            const seconds = secondsLeft % 60;
            const display = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            const displayElement = document.getElementById('timerDisplay');
            displayElement.textContent = display;
            
            // Add warning class if under 30 seconds
            if (secondsLeft <= 30 && secondsLeft > 0) {
                displayElement.classList.add('warning');
            } else {
                displayElement.classList.remove('warning');
            }
            
            // Play sound at 0 (optional - currently disabled)
            if (secondsLeft === 0) {
                document.getElementById('timerStatus').textContent = 'Time Up Time\'s Up!';
            }
        }

        function syncTimer() {
            if (!currentSession) return;
            
            database.ref(`sessions/${currentSession}/timer`).on('value', (snapshot) => {
                const timer = snapshot.val();
                if (!timer) {
                    updateTimerDisplay(0);
                    document.getElementById('timerStatus').textContent = 'Ready';
                    return;
                }
                
                if (timer.running) {
                    document.getElementById('timerStatus').textContent = '⏱ Running...';
                    
                    // Calculate actual seconds left based on server timestamp
                    if (timerInterval) clearInterval(timerInterval);
                    
                    timerInterval = setInterval(() => {
                        database.ref(`sessions/${currentSession}/timer`).once('value', (snap) => {
                            const t = snap.val();
                            if (!t || !t.running) {
                                clearInterval(timerInterval);
                                return;
                            }
                            
                            let secondsLeft = t.secondsLeft - 1;
                            if (secondsLeft < 0) secondsLeft = 0;
                            
                            updateTimerDisplay(secondsLeft);
                            
                            if (secondsLeft === 0) {
                                clearInterval(timerInterval);
                                database.ref(`sessions/${currentSession}/timer/running`).set(false);
                            } else {
                                database.ref(`sessions/${currentSession}/timer/secondsLeft`).set(secondsLeft);
                            }
                        });
                    }, 1000);
                } else {
                    if (timerInterval) clearInterval(timerInterval);
                    updateTimerDisplay(timer.secondsLeft || 0);
                    document.getElementById('timerStatus').textContent = timer.secondsLeft === 0 ? 'Time Up Time\'s Up!' : 'Pause Paused';
                }
            });
        }

        // ==================== MISSION/OBJECTIVES FUNCTIONS ====================
        function editMissionName() {
            if (!currentSession) return;
            
            database.ref(`sessions/${currentSession}/missionName`).once('value', (snapshot) => {
                const currentName = snapshot.val() || '';
                const newName = prompt('Enter mission name:', currentName);
                if (newName !== null) {
                    database.ref(`sessions/${currentSession}/missionName`).set(newName);
                }
            });
        }

        function toggleObjectives() {
            const container = document.getElementById('objectivesContainer');
            container.style.display = container.style.display === 'none' ? 'block' : 'none';
        }

        function addObjective() {
            if (!currentSession) return;
            const text = prompt('Enter objective:');
            if (text && text.trim()) {
                database.ref(`sessions/${currentSession}/objectives`).push({
                    text: text.trim(),
                    completed: false,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                });
            }
        }

        function toggleObjective(objectiveId) {
            if (!currentSession) return;
            const ref = database.ref(`sessions/${currentSession}/objectives/${objectiveId}`);
            ref.once('value', snapshot => {
                const obj = snapshot.val();
                if (obj) {
                    ref.update({ completed: !obj.completed });
                }
            });
        }

        function deleteObjective(objectiveId) {
            if (!currentSession) return;
            if (confirm('Delete this objective?')) {
                database.ref(`sessions/${currentSession}/objectives/${objectiveId}`).remove();
            }
        }

        function loadMissionObjectives() {
            if (!currentSession) return;
            
            // Load mission name
            database.ref(`sessions/${currentSession}/missionName`).on('value', snapshot => {
                const name = snapshot.val() || 'Click to set mission name...';
                document.getElementById('missionName').textContent = name;
                document.getElementById('missionName').style.color = snapshot.val() ? '#FF9500' : '#666';
            });
            
            // Load objectives
            database.ref(`sessions/${currentSession}/objectives`).on('value', snapshot => {
                const objectives = snapshot.val() || {};
                const container = document.getElementById('objectivesList');
                
                if (Object.keys(objectives).length === 0) {
                    container.innerHTML = '<div style="color: #666; text-align: center; padding: 10px;">No objectives yet. Click "Add Objective" to create one.</div>';
                } else {
                    container.innerHTML = Object.entries(objectives).map(([id, obj]) => `
                        <div class="objective-item ${obj.completed ? 'completed' : ''}">
                            <input type="checkbox" class="objective-checkbox" 
                                   ${obj.completed ? 'checked' : ''} 
                                   onchange="toggleObjective('${id}')">
                            <span class="objective-text">${obj.text}</span>
                            <button onclick="deleteObjective('${id}')" style="background: none; border: none; color: #ff4444; cursor: pointer; margin-left: auto;">Remove</button>
                        </div>
                    `).join('');
                }
            });
            
            // Show section
            document.getElementById('missionSection').style.display = 'block';
        }

        // ==================== V12 NEW FUNCTIONS ====================

        // Generate Starfield
        function generateStarfield() {
            const starfield = document.getElementById('starfield');
            const starCount = 100;
            
            for (let i = 0; i < starCount; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                star.style.left = Math.random() * 100 + '%';
                star.style.top = Math.random() * 100 + '%';
                const size = Math.random() * 2 + 1;
                star.style.width = size + 'px';
                star.style.height = size + 'px';
                star.style.animationDelay = Math.random() * 3 + 's';
                starfield.appendChild(star);
            }
        }

        // Mode Selection from Landing Page
        function selectMode(mode) {
            currentMode = mode;
            document.getElementById('landingPage').style.display = 'none';
            
            if (mode === 'quickplay') {
                // Show Quick Play menu
                showQuickPlayMenu();
            } else if (mode === 'joinsession') {
                // Show join session interface
                document.getElementById('appInterface').style.display = 'block';
                switchTab('join');
            } else if (mode === 'teambuilder') {
                // Show team builder
                showTeamBuilder();
            } else if (mode === 'lore') {
                // Show lore
                showLore();
            }
        }

        // Quick Play Menu
        function showQuickPlayMenu() {
            document.getElementById('teamBuilderTab').style.display = 'none';
            document.getElementById('myTeamsTab').style.display = 'none';
            document.getElementById('loreTab').style.display = 'none';
            document.getElementById('appInterface').style.display = 'none';
            
            // Create Quick Play menu
            const quickPlayMenu = document.createElement('div');
            quickPlayMenu.id = 'quickPlayMenu';
            quickPlayMenu.style.cssText = 'display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; padding: 20px; position: relative; z-index: 1;';
            
            quickPlayMenu.innerHTML = `
                <div style="text-align: center; margin-bottom: 40px;">
                    <button onclick="returnToLanding()" class="btn btn-secondary">← Back to Menu</button>
                </div>
                
                <h2 style="color: #FF9500; text-align: center; margin-bottom: 40px; font-size: 2em;">Quick Play Options</h2>
                
                <div style="display: grid; grid-template-columns: 1fr; gap: 20px; max-width: 500px; width: 100%;">
                    <button class="menu-button" onclick="showCreateSession()" style="padding: 30px 20px;">
                        Create New Session
                        <div style="font-size: 0.7em; margin-top: 10px; opacity: 0.8; font-weight: normal;">Start a fresh game and build your team</div>
                    </button>
                    
                    <button class="menu-button" onclick="showJoinSession()" style="padding: 30px 20px;">
                        Join Existing Session
                        <div style="font-size: 0.7em; margin-top: 10px; opacity: 0.8; font-weight: normal;">Enter a session code to join friends</div>
                    </button>
                    
                    <button class="menu-button" onclick="showQuickBuild()" style="padding: 30px 20px;">
                        Quick Build
                        <div style="font-size: 0.7em; margin-top: 10px; opacity: 0.8; font-weight: normal;">Auto-generate a team and jump right in</div>
                    </button>
                </div>
            `;
            
            document.body.appendChild(quickPlayMenu);
        }

        // Show Create Session
        function showCreateSession() {
            removeQuickPlayMenu();
            document.getElementById('appInterface').style.display = 'block';
            switchTab('join');
        }

        // Show Join Session
        function showJoinSession() {
            removeQuickPlayMenu();
            document.getElementById('appInterface').style.display = 'block';
            switchTab('join');
        }

        // Show Quick Build
        function showQuickBuild() {
            removeQuickPlayMenu();
            showQuickBuildInterface();
        }

        function removeQuickPlayMenu() {
            const menu = document.getElementById('quickPlayMenu');
            if (menu) menu.remove();
        }

        // Quick Build Interface
        function showQuickBuildInterface() {
            document.getElementById('teamBuilderTab').style.display = 'block';
            document.getElementById('myTeamsTab').style.display = 'none';
            document.getElementById('loreTab').style.display = 'none';
            
            const content = document.getElementById('teamBuilderContent');
            content.innerHTML = `
                <div style="text-align: center; margin-bottom: 30px;">
                    <button onclick="showQuickPlayMenu()" class="btn btn-secondary">← Back to Quick Play</button>
                </div>
                
                <h2 style="color: #FF9500; text-align: center; margin-bottom: 20px;">Initiative Quick Build - Auto-Generate Team</h2>
                <p style="text-align: center; color: #aaa; margin-bottom: 40px;">Choose a faction and we'll build a balanced 150-point team for you!</p>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; max-width: 1000px; margin: 0 auto;">
                    ${gameData.factions.filter(f => f.name === 'Arc Rangers' || f.name === 'Space-Wyrm').map(faction => `
                        <div class="faction-card" style="background: rgba(${hexToRgb(faction.primaryColor)}, 0.1); border: 2px solid ${faction.primaryColor}; border-radius: 10px; padding: 30px; cursor: pointer; transition: all 0.3s; text-align: center;" 
                             onclick="generateQuickTeam('${faction.name}')"
                             onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 10px 30px rgba(${hexToRgb(faction.primaryColor)}, 0.3)';"
                             onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                            <h3 style="color: ${faction.primaryColor}; margin-bottom: 15px; font-size: 1.5em;">${faction.name}</h3>
                            <p style="color: #ccc; margin-bottom: 20px; font-size: 0.9em;">${faction.loreShort}</p>
                            <button class="btn btn-primary" style="width: 100%; padding: 15px;">Generate Team</button>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // Generate Quick Team
        function generateQuickTeam(factionName) {
            const faction = gameData.factions.find(f => f.name === factionName);
            const factionModels = gameData.models.filter(m => m.faction === factionName);
            
            // Auto-generate a balanced team
            let autoTeam = [];
            let totalPoints = 0;
            const targetPoints = 150;
            
            // Add one leader/captain
            const leader = factionModels.find(m => m.type === 'Captain' || m.type === 'Leader');
            if (leader) {
                autoTeam.push({...leader, id: Date.now() + Math.random(), currentHealth: leader.health, status: 'alive', weapons: [], specialActions: [], inventory: []});
                totalPoints += leader.points;
            }
            
            // Add specialists and troopers to reach ~150pts
            const specialists = factionModels.filter(m => m.type === 'Specialist');
            const troopers = factionModels.filter(m => m.type === 'Trooper' || m.type === 'Warrior');
            
            // Add 2 specialists
            for (let i = 0; i < 2 && specialists.length > 0; i++) {
                const spec = specialists[i % specialists.length];
                if (totalPoints + spec.points <= targetPoints) {
                    autoTeam.push({...spec, id: Date.now() + Math.random() + i, currentHealth: spec.health, status: 'alive', weapons: [], specialActions: [], inventory: []});
                    totalPoints += spec.points;
                }
            }
            
            // Fill rest with troopers
            let trooperIndex = 0;
            while (totalPoints < targetPoints - 20 && troopers.length > 0) {
                const trooper = troopers[trooperIndex % troopers.length];
                if (totalPoints + trooper.points <= targetPoints) {
                    autoTeam.push({...trooper, id: Date.now() + Math.random() + trooperIndex, currentHealth: trooper.health, status: 'alive', weapons: [], specialActions: [], inventory: []});
                    totalPoints += trooper.points;
                    trooperIndex++;
                } else {
                    break;
                }
            }
            
            // Show preview
            showQuickTeamPreview(factionName, autoTeam, totalPoints);
        }

        function showQuickTeamPreview(factionName, team, points) {
            const faction = gameData.factions.find(f => f.name === factionName);
            const content = document.getElementById('teamBuilderContent');
            
            content.innerHTML = `
                <div style="max-width: 800px; margin: 0 auto;">
                    <div style="text-align: center; margin-bottom: 30px;">
                        <button onclick="showQuickBuildInterface()" class="btn btn-secondary">← Choose Different Faction</button>
                    </div>
                    
                    <h2 style="color: ${faction.primaryColor}; text-align: center; margin-bottom: 10px;">Your ${factionName} Team</h2>
                    <div style="text-align: center; color: #9CAF88; font-size: 1.3em; margin-bottom: 30px;">
                        <strong>${points} Points</strong> • ${team.length} Models
                    </div>
                    
                    <div style="background: rgba(255, 255, 255, 0.05); padding: 20px; border-radius: 10px; border: 1px solid ${faction.primaryColor}; margin-bottom: 30px;">
                        <h3 style="color: #FF9500; margin-bottom: 15px;">Team Roster:</h3>
                        ${team.map(model => `
                            <div style="padding: 10px; border-bottom: 1px solid rgba(255, 255, 255, 0.1); display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <strong style="color: ${faction.primaryColor};">${model.name}</strong>
                                    <span style="color: #888; margin-left: 10px; font-size: 0.9em;">${model.type}</span>
                                </div>
                                <span style="color: #9CAF88;">${model.points} pts</span>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div style="background: rgba(255, 149, 0, 0.1); padding: 20px; border-radius: 10px; border: 1px solid #FF9500; margin-bottom: 30px;">
                        <h3 style="color: #FF9500; margin-bottom: 10px;">Ready to Play?</h3>
                        <p style="color: #ccc;">Enter a session name and your player name to start playing!</p>
                        <div style="margin-top: 15px; display: grid; gap: 10px;">
                            <input type="text" id="quickSessionName" placeholder="Session Name (e.g., QuickGame-${factionName})" 
                                   style="width: 100%; padding: 12px; background: rgba(0,0,0,0.5); border: 1px solid #FF9500; color: white; border-radius: 5px;">
                            <input type="text" id="quickPlayerName" placeholder="Your Player Name" 
                                   style="width: 100%; padding: 12px; background: rgba(0,0,0,0.5); border: 1px solid #FF9500; color: white; border-radius: 5px;">
                        </div>
                    </div>
                    
                    <div style="text-align: center;">
                        <button onclick="startQuickGame('${factionName}', ${JSON.stringify(team).replace(/"/g, '&quot;')})" class="btn btn-primary" style="padding: 20px 60px; font-size: 1.3em;"> Start Playing!</button>
                    </div>
                </div>
            `;
        }

        function startQuickGame(factionName, team) {
            const sessionName = document.getElementById('quickSessionName').value.trim();
            const playerName = document.getElementById('quickPlayerName').value.trim();
            
            if (!sessionName) {
                alert('Please enter a session name!');
                return;
            }
            if (!playerName) {
                alert('Please enter your player name!');
                return;
            }
            
            // Store for later use
            currentPlayer = playerName;
            currentSession = sessionName;
            
            // Create session first
            const sessionRef = database.ref('sessions/' + sessionName);
            sessionRef.once('value', (snapshot) => {
                const sessionPromise = snapshot.exists() ? 
                    Promise.resolve() : 
                    sessionRef.set({
                        name: sessionName,
                        description: `Quick Build - ${factionName}`,
                        created: firebase.database.ServerValue.TIMESTAMP,
                        archived: false,
                        teams: {},
                        actionHistory: {},
                        combatLog: {},
                        initiative: {}
                    });
                
                sessionPromise.then(() => {
                    // Hide team builder
                    document.getElementById('teamBuilderTab').style.display = 'none';
                    
                    // Show app interface
                    document.getElementById('appInterface').style.display = 'block';
                    
                    // Set values in interface
                    document.getElementById('currentSession').textContent = sessionName;
                    document.getElementById('currentPlayer').textContent = playerName;
                    document.getElementById('gameTabBtn').style.display = 'block';
                    document.getElementById('toolsTabBtn').style.display = 'block';
                    document.getElementById('templatesTabBtn').style.display = 'block';
                    document.getElementById('gameArea').style.display = 'block';
                    
                    // Load mission/objectives
                    loadMissionObjectives();
                    syncTimer();
                    
                    // Set up teams listener
                    sessionRef.child('teams').on('value', (snapshot) => {
                        renderTeams(snapshot.val() || {});
                    });
                    
                    // Create team with faction
                    const teamId = currentPlayer.replace(/\s/g, '_');
                    const teamRef = database.ref(`sessions/${sessionName}/teams/${teamId}`);
                    teamRef.set({
                        owner: currentPlayer,
                        faction: factionName,
                        characters: {}
                    }).then(() => {
                        // Add characters
                        team.forEach((model, index) => {
                            setTimeout(() => {
                                addQuickTeamModel(model, factionName);
                            }, index * 100); // Stagger to avoid conflicts
                        });
                        
                        // Switch to game tab
                        setTimeout(() => {
                            switchTab('game');
                        }, team.length * 100 + 500);
                    });
                });
            });
        }

        function addQuickTeamModel(modelData, factionName) {
            if (!currentSession || !currentPlayer) return;
            
            const teamId = currentPlayer.replace(/\s/g, '_');
            const charId = 'char_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            
            database.ref(`sessions/${currentSession}/teams/${teamId}/characters/${charId}`).set({
                name: modelData.name,
                role: modelData.type,
                maxHealth: modelData.health,
                currentHealth: modelData.health,
                speed: modelData.speed,
                shoot: modelData.shoot,
                fight: modelData.fight,
                nerve: modelData.nerve,
                portrait: modelData.portrait,
                status: 'alive',
                turnTaken: false,
                weapons: [],
                consumables: [],
                specialActions: [],
                owner: currentPlayer
            });
        }

        // Return to Landing Page
        function returnToLanding() {
            document.getElementById('landingPage').style.display = 'flex';
            
        // Random Color Generator
        function generateRandomColor() {
            const colors = [
                '#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA07A', '#98D8C8',
                '#F7DC6F', '#BB8FCE', '#85C1E2', '#F8B739', '#52B788',
                '#FF9AA2', '#FFB7B2', '#FFDAC1', '#E2F0CB', '#B5EAD7',
                '#C7CEEA', '#FFB347', '#77DD77', '#AEC6CF', '#CFCFC4'
            ];
            return colors[Math.floor(Math.random() * colors.length)];
        }
            document.getElementById('appInterface').style.display = 'none';
            document.getElementById('teamBuilderTab').style.display = 'none';
            document.getElementById('myTeamsTab').style.display = 'none';
            document.getElementById('loreTab').style.display = 'none';
            removeQuickPlayMenu();
            currentMode = null;
            
            // Hide tabs
            document.getElementById('gameTabBtn').style.display = 'none';
            document.getElementById('toolsTabBtn').style.display = 'none';
            document.getElementById('templatesTabBtn').style.display = 'none';
        }

        // Team Builder Functions
        function showTeamBuilder() {
            document.getElementById('teamBuilderTab').style.display = 'block';
            document.getElementById('myTeamsTab').style.display = 'none';
            document.getElementById('loreTab').style.display = 'none';
            
            // Show faction selection
            showFactionSelector();
        }

        function showFactionSelector() {
            const content = document.getElementById('teamBuilderContent');
            content.innerHTML = `
                <div style="text-align: center; margin-bottom: 30px;">
                    <button onclick="returnToLanding()" class="btn btn-secondary">← Back to Menu</button>
                    <button onclick="showMyTeams()" class="btn btn-secondary"> My Teams</button>
                </div>
                <h3 style="color: #FF9500; text-align: center; margin-bottom: 30px;">Choose Your Faction</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; max-width: 1200px; margin: 0 auto;">
                    ${gameData.factions.map(faction => `
                        <div class="faction-card" style="background: rgba(${hexToRgb(faction.primaryColor)}, 0.1); border: 2px solid ${faction.primaryColor}; border-radius: 10px; padding: 20px; cursor: pointer; transition: all 0.3s;" 
                             onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 10px 30px rgba(${hexToRgb(faction.primaryColor)}, 0.3)';"
                             onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                            <h3 style="color: ${faction.primaryColor}; text-align: center; margin-bottom: 15px;">${faction.name}</h3>
                            <p style="color: #ccc; text-align: center; margin-bottom: 20px; font-size: 0.9em;">${faction.loreShort}</p>
                            <div style="display: flex; gap: 10px; justify-content: center;">
                                <button onclick="selectFaction('${faction.name}')" class="btn btn-primary">Select</button>
                                <button onclick="showFactionLore('${faction.name}')" class="btn btn-secondary">Lore</button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function hexToRgb(hex) {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? `${parseInt(result[1], 16)}, ${parseInt(result[2], 16)}, ${parseInt(result[3], 16)}` : '255, 149, 0';
        }

        function showFactionLore(factionName) {
            const faction = gameData.factions.find(f => f.name === factionName);
            if (!faction) return;
            
            const content = document.getElementById('teamBuilderContent');
            content.innerHTML = `
                <div style="max-width: 800px; margin: 0 auto;">
                    <button onclick="showFactionSelector()" class="btn btn-secondary" style="margin-bottom: 20px;">← Back to Factions</button>
                    <h2 style="color: ${faction.primaryColor}; text-align: center; margin-bottom: 20px;">${faction.name}</h2>
                    <div style="background: rgba(255, 255, 255, 0.05); padding: 30px; border-radius: 10px; border: 1px solid ${faction.primaryColor};">
                        <p style="color: #ccc; line-height: 1.8; white-space: pre-wrap;">${faction.loreFull}</p>
                    </div>
                    <div style="text-align: center; margin-top: 30px;">
                        <button onclick="selectFaction('${faction.name}')" class="btn btn-primary" style="padding: 15px 40px; font-size: 1.2em;">Build ${faction.name} Team</button>
                    </div>
                </div>
            `;
        }

        let currentTeam = {
            name: '',
            faction: '',
            models: [],
            points: 0
        };

        function selectFaction(factionName) {
            currentTeam.faction = factionName;
            currentTeam.models = [];
            currentTeam.points = 0;
            showTeamBuildingInterface();
        }

        function showTeamBuildingInterface() {
            const faction = gameData.factions.find(f => f.name === currentTeam.faction);
            const factionModels = gameData.models.filter(m => m.faction === currentTeam.faction);
            
            const content = document.getElementById('teamBuilderContent');
            content.innerHTML = `
                <div style="max-width: 1400px; margin: 0 auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <button onclick="showFactionSelector()" class="btn btn-secondary">← Change Faction</button>
                        <h2 style="color: ${faction.primaryColor};">Building ${currentTeam.faction} Team</h2>
                        <button onclick="saveCurrentTeam()" class="btn btn-primary"> Save Team</button>
                    </div>
                    
                    <div style="background: rgba(255, 255, 255, 0.05); padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                        <label style="color: #FF9500; font-weight: bold;">Team Name:</label>
                        <input type="text" id="teamNameInput" placeholder="e.g., Alpha Squad" value="${currentTeam.name}" 
                               onchange="currentTeam.name = this.value"
                               style="width: 100%; padding: 10px; margin-top: 5px; background: rgba(0,0,0,0.5); border: 1px solid #FF9500; color: white; border-radius: 5px;">
                        <div style="margin-top: 10px; color: #9CAF88; font-size: 1.2em;">
                            <strong>Total Points:</strong> <span id="teamPoints">${currentTeam.points}</span>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                        <!-- Model Presets -->
                        <div>
                            <h3 style="color: #FF9500; margin-bottom: 15px;">Available Models</h3>
                            <div style="display: grid; gap: 10px; max-height: 600px; overflow-y: auto;">
                                ${factionModels.map(model => `
                                    <div style="background: rgba(255, 255, 255, 0.05); padding: 15px; border-radius: 8px; border: 1px solid ${faction.primaryColor};">
                                        <div style="display: flex; justify-content: space-between; align-items: start;">
                                            <div>
                                                <strong style="color: ${faction.primaryColor};">${model.name}</strong>
                                                <span style="color: #9CAF88; margin-left: 10px;">${model.points} pts</span>
                                                <div style="color: #888; font-size: 0.85em; margin-top: 5px;">
                                                    ${model.type} | Spd:${model.speed} | Sht:${model.shoot} | Fgt:${model.fight} | Nrv:${model.nerve} | HP:${model.health}
                                                </div>
                                                <div style="color: #666; font-size: 0.8em; margin-top: 5px;">${model.description}</div>
                                            </div>
                                            <button onclick="addModelToTeam('${model.name}')" class="btn btn-success" style="padding: 8px 15px;">+</button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <!-- Current Team -->
                        <div>
                            <h3 style="color: #FF9500; margin-bottom: 15px;">Your Team (<span id="teamModelCount">${currentTeam.models.length}</span> models)</h3>
                            <div id="currentTeamRoster" style="display: grid; gap: 10px; max-height: 600px; overflow-y: auto;">
                                ${currentTeam.models.length === 0 ? '<div style="color: #666; text-align: center; padding: 40px;">No models yet. Add models from the left!</div>' : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            renderCurrentTeam();
        }

        function addModelToTeam(modelName) {
            const modelData = gameData.models.find(m => m.name === modelName);
            if (!modelData) return;
            
            // Create model instance
            const modelInstance = {
                ...modelData,
                id: Date.now() + Math.random(),
                currentHealth: modelData.health,
                status: 'alive',
                weapons: [],
                specialActions: [],
                inventory: []
            };
            
            currentTeam.models.push(modelInstance);
            currentTeam.points += modelData.points;
            
            renderCurrentTeam();
            updateTeamPoints();
        }

        function removeModelFromTeam(modelId) {
            const index = currentTeam.models.findIndex(m => m.id === modelId);
            if (index === -1) return;
            
            const model = currentTeam.models[index];
            currentTeam.points -= model.points;
            currentTeam.models.splice(index, 1);
            
            renderCurrentTeam();
            updateTeamPoints();
        }

        function renderCurrentTeam() {
            const container = document.getElementById('currentTeamRoster');
            if (!container) return;
            
            const faction = gameData.factions.find(f => f.name === currentTeam.faction);
            
            if (currentTeam.models.length === 0) {
                container.innerHTML = '<div style="color: #666; text-align: center; padding: 40px;">No models yet. Add models from the left!</div>';
                return;
            }
            
            container.innerHTML = currentTeam.models.map(model => `
                <div style="background: rgba(255, 255, 255, 0.05); padding: 15px; border-radius: 8px; border: 1px solid ${faction.primaryColor};">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div style="flex: 1;">
                            <strong style="color: ${faction.primaryColor};">${model.name}</strong>
                            <span style="color: #9CAF88; margin-left: 10px;">${model.points} pts</span>
                            <div style="color: #888; font-size: 0.85em; margin-top: 5px;">
                                ${model.type} | HP: ${model.health}
                            </div>
                        </div>
                        <button onclick="removeModelFromTeam(${model.id})" class="btn btn-danger" style="padding: 5px 10px;">Remove</button>
                    </div>
                </div>
            `).join('');
            
            document.getElementById('teamModelCount').textContent = currentTeam.models.length;
        }

        function updateTeamPoints() {
            document.getElementById('teamPoints').textContent = currentTeam.points;
        }

        function saveCurrentTeam() {
            if (!currentPlayer) {
                // Need to get player name first
                const playerNamePrompt = prompt('Please enter your player name to save this team:');
                if (!playerNamePrompt || !playerNamePrompt.trim()) {
                    alert('Player name required to save team!');
                    return;
                }
                currentPlayer = playerNamePrompt.trim();
                localStorage.setItem('lastPlayerName', currentPlayer);
            }
            
            if (!currentTeam.name) {
                alert('Please enter a team name!');
                document.getElementById('teamNameInput').focus();
                return;
            }
            
            if (currentTeam.models.length === 0) {
                alert('Please add at least one model to your team!');
                return;
            }
            
            const teamId = 'team_' + Date.now();
            const teamData = {
                ...currentTeam,
                created: Date.now(),
                modified: Date.now(),
                owner: currentPlayer
            };
            
            database.ref(`players/${currentPlayer}/teams/${teamId}`).set(teamData).then(() => {
                // Show success message with next steps
                showTeamSavedDialog(teamData.name);
            }).catch(error => {
                alert('Error saving team: ' + error.message);
            });
        }

        function showTeamSavedDialog(teamName) {
            const faction = gameData.factions.find(f => f.name === currentTeam.faction);
            const content = document.getElementById('teamBuilderContent');
            
            content.innerHTML = `
                <div style="max-width: 600px; margin: 60px auto; text-align: center;">
                    <div style="font-size: 4em; margin-bottom: 20px;"></div>
                    <h2 style="color: ${faction.primaryColor}; margin-bottom: 20px;">Team Saved Successfully!</h2>
                    <div style="background: rgba(${hexToRgb(faction.primaryColor)}, 0.1); padding: 30px; border-radius: 10px; border: 2px solid ${faction.primaryColor}; margin-bottom: 30px;">
                        <h3 style="color: ${faction.primaryColor}; margin-bottom: 10px;">"${teamName}"</h3>
                        <div style="color: #9CAF88; font-size: 1.1em;">
                            ${currentTeam.faction} • ${currentTeam.points} pts • ${currentTeam.models.length} models
                        </div>
                    </div>
                    
                    <h3 style="color: #FF9500; margin-bottom: 20px;">What would you like to do next?</h3>
                    
                    <div style="display: grid; gap: 15px; margin-top: 30px;">
                        <button onclick="prepareToJoinWithTeam('${teamName}')" class="btn btn-primary" style="padding: 20px; font-size: 1.1em;">
                             Join a Session with This Team
                        </button>
                        
                        <button onclick="showMyTeams()" class="btn btn-secondary" style="padding: 15px;">
                             View My Saved Teams
                        </button>
                        
                        <button onclick="showTeamBuilder()" class="btn btn-secondary" style="padding: 15px;">
                            Build Another Team
                        </button>
                        
                        <button onclick="returnToLanding()" class="btn btn-secondary" style="padding: 15px;">
                             Back to Main Menu
                        </button>
                    </div>
                </div>
            `;
        }

        function prepareToJoinWithTeam(teamName) {
            // Show join session interface
            document.getElementById('teamBuilderTab').style.display = 'none';
            document.getElementById('appInterface').style.display = 'block';
            
            // Pre-fill player name
            if (currentPlayer) {
                document.getElementById('playerName').value = currentPlayer;
            }
            
            // Switch to join tab
            switchTab('join');
            
            // Show helpful message
            const joinTab = document.getElementById('joinTab');
            const existingHint = joinTab.querySelector('.team-ready-hint');
            if (!existingHint) {
                const hint = document.createElement('div');
                hint.className = 'team-ready-hint';
                hint.style.cssText = 'background: rgba(76, 175, 80, 0.1); padding: 20px; border-radius: 10px; border: 1px solid #4CAF50; margin-bottom: 20px; text-align: center;';
                hint.innerHTML = `
                    <h3 style="color: #4CAF50; margin-bottom: 10px;"> Team "${teamName}" Ready!</h3>
                    <p style="color: #ccc;">Enter a session name below to create or join a game with your team.</p>
                `;
                joinTab.querySelector('.session-controls').insertBefore(hint, joinTab.querySelector('.session-controls').firstChild);
            }
        }

        // My Teams Functions
        function showMyTeams() {
            document.getElementById('teamBuilderTab').style.display = 'none';
            document.getElementById('myTeamsTab').style.display = 'block';
            document.getElementById('loreTab').style.display = 'none';
            
            // Try to get player name from current session or localStorage
            if (!currentPlayer) {
                const savedPlayerName = localStorage.getItem('lastPlayerName');
                if (savedPlayerName) {
                    currentPlayer = savedPlayerName;
                } else {
                    document.getElementById('myTeamsContent').innerHTML = `
                        <div style="text-align: center; padding: 40px;">
                            <p style="color: #aaa; margin-bottom: 20px;">Enter your player name to view your teams:</p>
                            <input type="text" id="tempPlayerName" placeholder="Your player name" style="padding: 10px; width: 300px; margin-bottom: 15px; background: rgba(0,0,0,0.5); border: 1px solid #FF9500; color: white; border-radius: 5px;">
                            <br>
                            <button onclick="setPlayerNameFromTemp()" class="btn btn-primary">Load My Teams</button>
                            <button onclick="returnToLanding()" class="btn btn-secondary" style="margin-left: 10px;">← Back to Menu</button>
                        </div>
                    `;
                    return;
                }
            }
            
            loadPlayerTeams();
        }
        
        function setPlayerNameFromTemp() {
            const name = document.getElementById('tempPlayerName').value.trim();
            if (!name) {
                alert('Please enter your player name');
                return;
            }
            currentPlayer = name;
            localStorage.setItem('lastPlayerName', name);
            showMyTeams();
        }

        function loadPlayerTeams() {
            database.ref(`players/${currentPlayer}/teams`).once('value', snapshot => {
                const teams = snapshot.val() || {};
                displayTeamLibrary(teams);
            });
        }

        function displayTeamLibrary(teams) {
            const content = document.getElementById('myTeamsContent');
            const teamsList = Object.entries(teams);
            
            content.innerHTML = `
                <div style="max-width: 1200px; margin: 0 auto;">
                    <div style="text-align: center; margin-bottom: 30px;">
                        <button onclick="returnToLanding()" class="btn btn-secondary">← Back to Menu</button>
                        <button onclick="showTeamBuilder()" class="btn btn-primary">Build New Team</button>
                    </div>
                    
                    ${teamsList.length === 0 ? `
                        <div style="text-align: center; padding: 60px; color: #666;">
                            <h3>No teams yet!</h3>
                            <p>Click "Build New Team" to create your first squad.</p>
                        </div>
                    ` : `
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px;">
                            ${teamsList.map(([teamId, team]) => {
                                const faction = gameData.factions.find(f => f.name === team.faction);
                                return `
                                    <div style="background: rgba(255, 255, 255, 0.05); padding: 20px; border-radius: 10px; border: 2px solid ${faction ? faction.primaryColor : '#FF9500'};">
                                        <h3 style="color: ${faction ? faction.primaryColor : '#FF9500'}; margin-bottom: 10px;">${team.name}</h3>
                                        <div style="color: #9CAF88; margin-bottom: 15px;">
                                            <div>${team.faction}</div>
                                            <div>${team.points} points • ${team.models.length} models</div>
                                        </div>
                                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                            <button onclick="editTeam('${teamId}')" class="btn btn-secondary" style="flex: 1;"> Edit</button>
                                            <button onclick="deleteTeamConfirm('${teamId}', '${team.name}')" class="btn btn-danger" style="flex: 1;"> Delete</button>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    `}
                </div>
            `;
        }

        function editTeam(teamId) {
            database.ref(`players/${currentPlayer}/teams/${teamId}`).once('value', snapshot => {
                const team = snapshot.val();
                if (team) {
                    currentTeam = { ...team };
                    showTeamBuildingInterface();
                }
            });
        }

        function deleteTeamConfirm(teamId, teamName) {
            if (confirm(`Are you sure you want to delete "${teamName}"?`)) {
                database.ref(`players/${currentPlayer}/teams/${teamId}`).remove().then(() => {
                    alert('Team deleted successfully!');
                    loadPlayerTeams();
                });
            }
        }

        // Load Team into Session Functions
        function showLoadTeamModal() {
            if (!currentSession) {
                alert('Please join a session first!');
                return;
            }
            
            // Try to get player name from current session or localStorage
            let playerName = currentPlayer || localStorage.getItem('lastPlayerName');
            if (!playerName) {
                alert('Player name not set!');
                return;
            }
            
            // Load player's teams
            database.ref(`players/${playerName}/teams`).once('value', snapshot => {
                const teams = snapshot.val();
                const teamsList = document.getElementById('loadTeamList');
                
                if (!teams || Object.keys(teams).length === 0) {
                    teamsList.innerHTML = `<div style="text-align: center; color: #888; padding: 40px;">
                        <p>No saved teams found for player "${playerName}".</p>
                        <p style="margin-top: 10px;">Build a team first in the Team Builder!</p>
                    </div>`;
                } else {
                    teamsList.innerHTML = Object.entries(teams).map(([teamId, team]) => {
                        const faction = gameData.factions.find(f => f.name === team.faction);
                        const factionColor = faction ? faction.primaryColor : '#FF9500';
                        return `
                            <div onclick="loadTeamIntoSession('${teamId}')" style="background: rgba(${hexToRgb(factionColor)}, 0.1); padding: 20px; border-radius: 10px; border: 2px solid ${factionColor}; cursor: pointer; transition: all 0.3s;"
                                 onmouseover="this.style.transform='translateY(-3px)'; this.style.boxShadow='0 5px 15px rgba(${hexToRgb(factionColor)}, 0.3)';"
                                 onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                                <h3 style="color: ${factionColor}; margin-bottom: 10px;">${team.name}</h3>
                                <div style="color: #9CAF88;">
                                    <div><strong>${team.faction || 'No Faction'}</strong></div>
                                    <div>${team.points} points • ${team.models.length} models</div>
                                </div>
                                <div style="color: #ccc; font-size: 0.9em; margin-top: 10px;">
                                    ${team.models.map(m => m.name).join(', ')}
                                </div>
                            </div>
                        `;
                    }).join('');
                }
                
                document.getElementById('loadTeamModal').classList.add('active');
            });
        }

        function closeLoadTeamModal() {
            document.getElementById('loadTeamModal').classList.remove('active');
        }

        function loadTeamIntoSession(teamId) {
            database.ref(`players/${currentPlayer}/teams/${teamId}`).once('value', snapshot => {
                const team = snapshot.val();
                if (!team) {
                    alert('Team not found!');
                    return;
                }
                
                if (!confirm(`Load "${team.name}" into session? This will replace your current characters.`)) {
                    return;
                }
                
                const teamSessionId = currentPlayer.replace(/\s/g, '_');
                const teamRef = database.ref(`sessions/${currentSession}/teams/${teamSessionId}`);
                
                // Clear existing characters first
                teamRef.child('characters').remove().then(() => {
                    // Set team with faction
                    teamRef.update({
                        owner: currentPlayer,
                        faction: team.faction
                    }).then(() => {
                        // Add each model
                        team.models.forEach((model, index) => {
                            setTimeout(() => {
                                const charId = 'char_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                                teamRef.child(`characters/${charId}`).set({
                                    name: model.name,
                                    role: model.role || model.type || 'Warrior',
                                    maxHealth: model.health || 15,
                                    currentHealth: model.health || 15,
                                    speed: model.speed || '6"',
                                    shoot: model.shoot || '4+',
                                    fight: model.fight || '4+',
                                    nerve: model.nerve || '4+',
                                    portrait: model.portrait || '',
                                    status: 'alive',
                                    turnTaken: false,
                                    weapons: model.weapons || [],
                                    consumables: model.consumables || [],
                                    specialActions: model.specialActions || [],
                                    inventory: model.inventory || [],
                                    notes: model.notes || '',
                                    owner: currentPlayer
                                });
                            }, index * 100);
                        });
                        
                        closeLoadTeamModal();
                        alert(`Team "${team.name}" loaded successfully!`);
                    });
                });
            });
        }

        // Lore Functions
        function showLore() {
            document.getElementById('teamBuilderTab').style.display = 'none';
            document.getElementById('myTeamsTab').style.display = 'none';
            document.getElementById('loreTab').style.display = 'block';
            
            displayLoreContent();
        }

        function displayLoreContent() {
            const content = document.getElementById('loreContent');
            content.innerHTML = `
                <div style="max-width: 900px; margin: 0 auto;">
                    <div style="text-align: center; margin-bottom: 30px;">
                        <button onclick="returnToLanding()" class="btn btn-secondary">← Back to Menu</button>
                    </div>
                    
                    <div style="margin-bottom: 40px; padding: 30px; background: rgba(255, 149, 0, 0.1); border-radius: 10px; border: 1px solid #FF9500;">
                        <h2 style="color: #FF9500; text-align: center; margin-bottom: 20px;">Welcome to The Reach</h2>
                        <p style="color: #ccc; line-height: 1.8;">
                            In the year 3030, humanity has spread across The Reach - a vast network of space colonies orbiting Earth. 
                            But The Reach is beset by threats from all sides: ancient enemies awakened, genetic rebellions, 
                            parasitic infections from deep space, and the horrors of Earth's blasted surface rising up.
                        </p>
                    </div>
                    
                    <h3 style="color: #FF9500; margin-top: 40px; margin-bottom: 20px;">Factions of The Reach</h3>
                    
                    ${gameData.factions.map(faction => `
                        <div style="margin-bottom: 30px; padding: 25px; background: rgba(255, 255, 255, 0.05); border-radius: 10px; border: 1px solid ${faction.primaryColor};">
                            <h3 style="color: ${faction.primaryColor}; margin-bottom: 15px;">${faction.name}</h3>
                            <p style="color: #aaa; font-style: italic; margin-bottom: 15px;">${faction.loreShort}</p>
                            <p style="color: #ccc; line-height: 1.8; white-space: pre-wrap;">${faction.loreFull}</p>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // Initialize on page load
        window.addEventListener('load', function() {
            generateStarfield();
            
            // Load saved player name
            const savedPlayerName = localStorage.getItem('lastPlayerName');
            if (savedPlayerName) {
                document.getElementById('playerName').value = savedPlayerName;
            }
        });
    </script>
    </div> <!-- end main-content -->
    </div> <!-- end appInterface -->

    <!-- Team Builder Tab -->
    <div id="teamBuilderTab" class="tab-content" style="display: none;">
        <h2 style="color: #FF9500; text-align: center;">Team Builder</h2>
        <div id="teamBuilderContent"></div>
    </div>

    <!-- My Teams Tab -->
    <div id="myTeamsTab" class="tab-content" style="display: none;">
        <h2 style="color: #FF9500; text-align: center;"> My Teams</h2>
        <div id="myTeamsContent"></div>
    </div>

    <!-- Lore Tab -->
    <div id="loreTab" class="tab-content" style="display: none;">
        <h2 style="color: #FF9500; text-align: center;"> The Lore of Space Ops 3030</h2>
        <div id="loreContent"></div>
    </div>

    <!-- Load Team Modal -->
    <div id="loadTeamModal" class="modal">
        <div class="modal-content">
            <h2>Load Saved Team into Session</h2>
            <p style="color: #aaa; margin-bottom: 20px;">Select a team to load into the current session. This will replace your current characters.</p>
            <div id="loadTeamList" style="display: grid; gap: 15px; max-height: 400px; overflow-y: auto;">
                <!-- Teams will be loaded here -->
            </div>
            <div class="form-actions" style="margin-top: 20px;">
                <button class="btn btn-secondary" onclick="closeLoadTeamModal()">Cancel</button>
            </div>
        </div>
    </div>

</body>
</html>
